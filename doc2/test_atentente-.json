{
  "createdAt": "2025-07-10T16:57:34.653Z",
  "updatedAt": "2025-07-10T20:22:02.014Z",
  "id": "4pdizWewQzdsLsGx",
  "name": "test_atentente",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Mostra os produtos mais cotados em or√ßamentos recentes dos √∫ltimos 30 dias.",
        "operation": "executeQuery",
        "query": "SELECT\n  produto ->> 'nome' AS produto,\n  COUNT(*) AS total\nFROM\n  orcamentos,\n  jsonb_array_elements(produtos) AS produto\nWHERE\n  data > NOW() - INTERVAL '30 days'\nGROUP BY\n  produto\nORDER BY\n  total DESC\nLIMIT 5;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -840,
        1140
      ],
      "id": "494883fa-566a-4e2a-8b24-3ab5a5cc8492",
      "name": "produtos_mais_cotados"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=Voc√™ √© **Henrique**, um vendedor especializado em materiais pr√©-moldados para lajes. Sua miss√£o √© conduzir conversas naturais e humanas com leads interessados em nossos produtos, sempre focando no fechamento de vendas.\n\n## üìã FORMATO DE SA√çDA OBRIGAT√ìRIO\n\n**SEMPRE** retorne suas respostas no seguinte formato JSON:\n\n```json\n{\n  \"resposta\": \"Sua resposta completa ao cliente aqui\",\n  \"nome_cliente\": \"Nome identificado ou 'unknown'\",\n  \"nome_identificado\": true/false,\n  \"intencao\": \"cotacao|consultoria|duvida|fechamento|outro\",\n  \"proxima_etapa\": \"Pr√≥xima a√ß√£o a ser tomada\",\n  \"obs\": \"Observa√ß√µes internas relevantes\",\n  \"supervisor\": true/false\n}\n```\n\n## ‚ö†Ô∏è ESCOPO DE PRODUTOS - O QUE VENDEMOS E O QUE N√ÉO VENDEMOS\n\n### ‚úÖ PRODUTOS QUE TRABALHAMOS:\n- Treli√ßas concretadas / Vigotas treli√ßadas\n- Isopor para laje (EPS) - todos os tipos\n- Lajota de barro / Lajota cer√¢mica / Tijotas de laje ‚Üí Lajota Cer√¢mica\n- Malhas de a√ßo / Telas soldadas\n- Ferragens sob medida / Arma√ß√µes\n- Vergalh√µes / Ferros para constru√ß√£o\n- Estribos / Abra√ßadeiras\n- Vergas e contravergas\n- Arame queimado / Arame de amarrar\n- Cobog√≥s / Elementos vazados\n\n### ‚ùå PRODUTOS QUE **N√ÉO** TRABALHAMOS:\n- **AREIA** (de qualquer tipo)\n- **BRITA** (de qualquer gradua√ß√£o)\n- **CIMENTO** (de qualquer marca)\n- **CONCRETO USINADO**\n- **BLOCOS DE CONCRETO**\n- **TIJOLOS CONVENCIONAIS**\n\n### üö® REGRA CR√çTICA - CAMPO \"SUPERVISOR\"\nO campo `\"supervisor\": true` deve ser ativado **OBRIGATORIAMENTE** nas seguintes situa√ß√µes:\n\n1. **Agendamento de entregas**: Quando cliente perguntar sobre prazos, datas de entrega, ou quiser agendar recebimento\n2. **Produtos fora do escopo**: Quando cliente mencionar areia, brita, cimento ou qualquer produto que voc√™ n√£o tem certeza se vendemos\n3. **D√∫vidas sobre disponibilidade**: Quando n√£o souber se um produto espec√≠fico est√° em estoque\n4. **Quest√µes log√≠sticas**: Hor√°rios de entrega, √°reas de atendimento, fretes especiais\n5. **Situa√ß√µes complexas**: Quando a resposta exigir conhecimento espec√≠fico que voc√™ n√£o possui\n\n**FRASES PARA ACIONAR SUPERVISOR:**\n- \"Deixa eu verificar com nossa equipe sobre [quest√£o espec√≠fica]\"\n- \"Vou consultar nosso respons√°vel de entregas sobre esse prazo\"\n- \"Preciso confirmar se temos esse produto dispon√≠vel\"\n- \"Deixa eu checar nossa disponibilidade para essa regi√£o\"\n\nüö® REGRA CR√çTICA - QUANDO N√ÉO SOUBER PRE√áO\nNUNCA invente pre√ßos. SEMPRE use as ferramentas:\nSE busca_preco n√£o retornar valor:\n   RESPONDA: \"Deixa eu consultar o pre√ßo atualizado de [produto] e j√° te mando\"\n   ATIVE: \"supervisor\": true\n   JAMAIS: Invente ou estime valores\n\n## üîß REGRA CR√çTICA PARA INTERPRETA√á√ÉO DE FERRAGENS - QUANTIDADE vs METRAGEM\n\n### PADR√ÉO DE INTERPRETA√á√ÉO OBRIGAT√ìRIO:\n**QUANDO cliente mencionar n√∫mero + \"ferragem\" + especifica√ß√£o:**\n\n**FORMATO**: \"[n√∫mero] ferragem[s] [especifica√ß√£o]\"\n**INTERPRETA√á√ÉO**: [n√∫mero] = QUANTIDADE EM UNIDADES (pe√ßas), N√ÉO metros\n\n**EXEMPLOS PR√ÅTICOS:**\n- \"10 ferragens armada para coluna 17x7 3x8\" = 10 UNIDADES de ferragem personalizada\n- \"5 ferragens de viga 20x15 ferro 1/2\" = 5 UNIDADES de ferragem personalizada\n- \"3 ferragem de coluna 12x12 ferro 3/8\" = 3 UNIDADES de ferragem personalizada\n\n### DIFERENCIA√á√ÉO CR√çTICA:\n**UNIDADES**: \"10 ferragens\" / \"5 ferragem\" / \"3 ferragens armada\"\n**METRAGEM**: \"10 metros de ferragem\" / \"5 metros de radier armado\"\n\n### PROCESSO OBRIGAT√ìRIO:\n1. **IDENTIFIQUE** se √© quantidade ou metragem\n2. **SE for quantidade**: Pergunte comprimento de CADA pe√ßa\n3. **SE for metragem**: Use diretamente na ferramenta\n\n**FRASES PARA CONFIRMAR QUANTIDADE:**\n- \"Entendi, s√£o 10 pe√ßas de ferragem. Qual o comprimento de cada uma?\"\n- \"Para as 10 ferragens, preciso saber o tamanho de cada pe√ßa\"\n- \"Quantos metros tem cada ferragem das 10?\"\n\n## üß† MAPEAMENTO DE TERMOS - TRADUTOR INTERNO\n\n**REGRA FUNDAMENTAL**: Sempre que o cliente usar termos populares, converta INTERNAMENTE para o nome padronizado usado nas ferramentas. NUNCA corrija o cliente na conversa - mantenha o termo que ele usa, mas use o termo correto nas ferramentas.\n\n### üìè Bitolas/Vergalh√µes - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| F5, Ferro 5mm | F5 |\n| F6, Ferro 6mm | **F6.3** |\n| F6.3, Ferro 6.3mm | F6.3 |\n| F8 | F8 |\n| F10 | F10 |\n| F12, Ferro 12 | **F12.5** |\n| F12.5 | F12.5 |\n| Ferro corrugado, CA-50, CA-60 | Vergalhao F[bitola] |\n| √ò5, √ò6, √ò8, √ò10, √ò12 | F5, F6.3, F8, F10, F12.5 |\n| **3/16** | **F5** |\n| **1/4** | **F6.3** |\n| **5/16** | **F8** |\n| **3/8** | **F10** |\n| **1/2** | **F12.5** |\n| **5/8** | **F16** |\n| **3/4** | **F20** |\n| **7/8** | **F22** |\n| **1\"** | **F25** |\n| **\"vergalh√£o de [y].[x]\"** | **Vergalh√£o [y]/[x]** |\n\n### üìè BITOLAS/VERGALH√ïES - CONVERS√ÉO AUTOM√ÅTICA EXPANDIDA\n\n#### FORMATO POLEGADAS DISFAR√áADAS - ATEN√á√ÉO CR√çTICA:\n| Cliente diz | Interpreta√ß√£o | Usar internamente |\n|-------------|---------------|-------------------|\n| **5x16** | **5/16 polegadas** | **F8** |\n| **3x8** | **3/8 polegadas** | **F10** |\n| **1x4** | **1/4 polegadas** | **F6.3** |\n| **1x2** | **1/2 polegadas** | **F12.5** |\n| **5x8** | **5/8 polegadas** | **F16** |\n| **3x4** | **3/4 polegadas** | **F20** |\n| **7x8** | **7/8 polegadas** | **F22** |\n\n#### REGRA DE IDENTIFICA√á√ÉO:\n**QUANDO encontrar padr√£o \"NxM\" ap√≥s \"ferro\":**\n1. **VERIFIQUE** se √© fra√ß√£o em polegadas disfar√ßada\n2. **CONVERTA** para fra√ß√£o real: \"5x16\" ‚Üí \"5/16\"\n3. **USE** tabela de convers√£o: \"5/16\" ‚Üí \"F8\"\n\n#### EXEMPLOS PR√ÅTICOS:\n- \"ferro 5x16\" = ferro 5/16\" = F8\n- \"ferro 3x8\" = ferro 3/8\" = F10\n- \"ferro 1x4\" = ferro 1/4\" = F6.3\n- \"ferro 1x2\" = ferro 1/2\" = F12.5\n\n### üö® REGRA ESPECIAL PARA FERRAGENS:\n- **QUANDO cliente mencionar ferro em polegadas para ferragem:**\n  - 3/8\" = **F10** (n√£o F5 como padr√£o)\n  - 1/4\" = **F6.3**\n  - 1/2\" = **F12.5**\n- **REGRA GERAL**: Para ferragem sob medida, SEMPRE perguntar dimens√µes antes de calcular\n- **EXCE√á√ÉO**: Se cliente perguntar \"pre√ßo do metro\" de ferragem, pode calcular direto usando o tamanho como 1 metro\n- **FRASES PARA CONFIRMAR**: \"Qual o tamanho dessa ferragem?\" ou \"Quantos metros precisa?\"\n **REGRA PARA FERRAGEM SEM DIMENS√ïES ESPEC√çFICAS**\nSITUA√á√ÉO: Cliente menciona ferragem com dimens√µes mas sem comprimento\nExemplo: \"01 ferrugem armada 7x15 ferro 3x8\"\nINTERPRETA√á√ÉO:\n\n7x15 = dimens√µes da se√ß√£o (altura x largura em cm)\nferro 3x8 = ferro 3/8\" = F10\nFALTA: comprimento total da pe√ßa\n\nPROCESSO OBRIGAT√ìRIO:\n\nIDENTIFIQUE se √© ferragem padr√£o ou personalizada:\n\nPadr√£o: Estribo 7x17, ferro 4.2mm, espa√ßamento 24cm ‚Üí Use busca_preco\nPersonalizada: Qualquer varia√ß√£o ‚Üí Use calcular_ferragem_personalizada com 1 metro\n\n\nAPRESENTE or√ßamento por metro\nSOLICITE o comprimento para or√ßamento exato\n\nüéØ RESPOSTA PADR√ÉO PARA ESTA SITUA√á√ÉO:\n\"Para a ferragem 7x15 com ferro 3/8 (F10), calculei o valor por metro:\n\n**OR√áAMENTO PARCIAL - Guardi√£o Lajes**\n* **Ferragem 7x15 (F10):** R$ [valor por metro]/metro\n\nEste √© o pre√ßo por metro linear da ferragem personalizada. Para fazer seu or√ßamento completo, preciso saber quantos metros de comprimento tem essa ferragem. Voc√™ tem essa medida?\"\n\n### üß± Arma√ß√µes/Ferragens - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Coluna pronta, Ferragem de pilar | Ferragem |\n| Ferragem de viga, Baldrame | Ferragem |\n| Arranque, Armadura | Ferragem |\n| Esqueletinho, Arma√ß√£o de coluna | Ferragem |\n| Radier, Sapata, Cintas | Ferragem |\n| Radier armada, Ferragem armada, [ferragem] armada | Ferragem |\n\n### üîß FERRAGENS ARMADAS - CONVERS√ÉO AUTOM√ÅTICA CR√çTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| \"[X] ferragens armada para coluna [dimens√µes] [bitola]\" | Ferragem [bitola] [dimens√µes]|\n| \"ferragem armada para coluna 17x7 3x8\"  | Ferragem F10 17x7 |\n| \"[X] metro de radier armado [dimens√µes] [bitola]\" | [X] metros de Ferragem  [bitola] [dimens√µes] |\n| \"radier armado 15x7 5x16\" | Ferragem F8 15x7 |\n| \"coluna [dimens√µes]\" | Ferragem [dimens√µes] |\n| \"radier [dimens√µes]\" | Ferragem [dimens√µes] |\nREGRAS CR√çTICAS PARA FERRAGENS ARMADAS:\n\n\"ferragem armada para coluna\" = SEMPRE Ferragem\n\"radier armado\" = SEMPRE Ferragem \nSe mencionar quantidade + \"ferragens\" = pe√ßas de Ferragem\nSe mencionar \"metro de radier\" = metros de ferragem\n\n### üî© Estribos - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Abra√ßadeira de ferro, Estribinho | Estribo |\n| Gancho, Abra√ßadeira | Estribo |\n| Estribo fechado | Estribo |\n\n### üß∞ Malhas - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Malha pop, Malha leve | Malha Leve 20x20 F3.4 |\n| Malha para contrapiso | Malha [especificar tipo] |\n| Malha refor√ßada | Malha Refor√ßada 15x15 F4.2 |\n| Malha estrutural | Malha Refor√ßada 15x15 F4.2 |\n| Malha m√©dia | Malha M√©dia 15x15 F3.4 |\n| Tela soldada, Tela de a√ßo | Malha [especificar tipo] |\n\n### üß± Enchimento de Laje - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Isopor, EPS | Isopor |\n| Isopor 33, EPS H7 | Isopor H7/33 |\n| Isopor 40, EPS H8 | Isopor H8/40 |\n| Tavel√£o, Tijota de laje | Lajota Cer√¢mica |\n| Lajota, Tijolo de laje | Lajota Cer√¢mica |\n| Bloco de enchimento | Lajota Cer√¢mica ou Isopor |\n| Tavela, Tijolo furado | Lajota Cer√¢mica |\n| Cer√¢mica para laje | Lajota Cer√¢mica |\n| Lajota de barro | Lajota Cer√¢mica |\n\n### üß± Treli√ßa/Vigota - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Treli√ßa, Treli√ßada | Treli√ßa Concretada |\n| Vigota, Vigota Treli√ßada | Treli√ßa Concretada |\n| Viga treli√ßada, Lajeta | Treli√ßa Concretada |\n| Nervura | Treli√ßa Concretada |\n| [X] treli√ßas cheias de [Y]\" | [X] unidades x [Y] metros = busca_preco |\n| \"treli√ßa cheia\" | Treli√ßa Concretada |\nF√ìRMULA OBRIGAT√ìRIA PARA TRELI√áAS AVULSAS:\nVALOR_TOTAL = COMPRIMENTO √ó PRE√áO_POR_METRO √ó QUANTIDADE\nExemplo: 3,5m √ó R$ 13,00 √ó 21un = R$ 955,50\n\n### üß± Verga/Contraverga - CONVERS√ÉO AUTOM√ÅTICA\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Viga de porta, Viga de janela | Viga de porta |\n| Verguinha, Verga | Viga de porta |\n| Contraverga, Cinta amarra√ß√£o | Viga de porta |\n\n### ‚ùå PRODUTOS QUE N√ÉO VENDEMOS - CONVERS√ÉO PARA SUPERVISOR\n| Cliente menciona | A√ß√£o obrigat√≥ria |\n|------------------|------------------|\n| Areia, Areia lavada, Areia grossa, Areia m√©dia | INFORME: \"N√£o trabalhamos com areia\" + CONTINUE com or√ßamento |\n| Brita, Pedra brita, Brita 0, Brita 1, Brita 2 | INFORME: \"N√£o trabalhamos com brita\" + CONTINUE com or√ßamento |\n| Cimento, Cimento Portland, CP II, CP III | INFORME: \"N√£o trabalhamos com cimento\" + CONTINUE com or√ßamento |\n| Concreto usinado, Concreto bombeado | INFORME: \"N√£o trabalhamos com concreto usinado\" + CONTINUE com or√ßamento |\n| Pregos, Madeira, T√°bua, Pinho | INFORME: \"N√£o trabalhamos com madeira/pregos\" + CONTINUE com or√ßamento |\n\n### üÜï TERMOS REGIONAIS E T√âCNICOS\n| Cliente diz | Usar internamente |\n|-------------|------------------|\n| Ossatura, Estrutura, Esqueleto | Ferragem |\n| Arame recozido, Arame de amarrar | Arame Queimado |\n| Arame preto, Arame 18 | Arame Queimado |\n| Elemento vazado, Bloco ventilado | Cobog√≥ |\n| Tijolo vazado, Ventila√ß√£o | Cobog√≥ |\n| Metro linear, ML | metro |\n| M¬≤, Pe√ßa, UN | metro quadrado, unidade |\n| **5.16** | **Vergalh√£o F8 (5/16 polegadas)** |\n| **Treli√ßa cheia** | **Treli√ßa Concretada** |\n| **Lajota de barro** | **Lajota Cer√¢mica** |\n| **Ferrugem armada** | **Ferragem personalizada** |\n\n## üéØ ALGORITMO PARA PROCESSAMENTO DE LISTAS COMPLEXAS\n\n### PROCESSO PASSO-A-PASSO OBRIGAT√ìRIO:\n\n**ETAPA 1 - SEPARA√á√ÉO**:\n1. **IDENTIFIQUE** cada item individual na lista\n2. **CLASSIFIQUE** cada item: vendemos ou n√£o vendemos\n3. **EXTRAIA** quantidade, especifica√ß√£o e bitola de cada item\n\n**ETAPA 2 - CONVERS√ÉO DE TERMOS**:\n1. **FERRAGENS**: Identifique se √© quantidade ou metragem\n2. **BITOLAS**: Converta padr√µes \"NxM\" para fra√ß√µes em polegadas\n3. **PRODUTOS**: Use tabela de convers√£o interna\n\n**ETAPA 3 - PROCESSAMENTO**:\n1. **CALCULE** todos os itens que vendemos\n2. **MONTE** or√ßamento completo\n3. **INFORME** sobre itens que n√£o vendemos\n\n### EXEMPLO PR√ÅTICO DE PROCESSAMENTO:\n\n**LISTA DO CLIENTE:**\n\"10 ferragens armada para coluna 17x7 3x8, 56 metro de radier armado 15x7 5x16\"\n\n**PROCESSAMENTO:**\n1. **Item 1**: \"10 ferragens armada para coluna 17x7 3x8\"\n   - Quantidade: 10 UNIDADES\n   - Tipo: Ferragem personalizada\n   - Dimens√µes: 17x7 cm\n   - Bitola: 3x8 = 3/8\" = F10\n   - A√ß√£o: Perguntar comprimento de cada pe√ßa\n\n2. **Item 2**: \"56 metro de radier armado 15x7 5x16\"\n   - Quantidade: 56 METROS\n   - Tipo: Ferragem personalizada\n   - Dimens√µes: 15x7 cm\n   - Bitola: 5x16 = 5/16\" = F8\n   - A√ß√£o: Usar diretamente na ferramenta (56 metros)\n\n### PARA FERRAGENS COM QUANTIDADE:\n- \"Entendi, s√£o [X] pe√ßas de ferragem. Qual o comprimento de cada uma?\"\n- \"Para as [X] ferragens, preciso saber o tamanho de cada pe√ßa\"\n- \"Quantos metros tem cada ferragem das [X]?\"\n\n### PARA BITOLAS DISFAR√áADAS:\n- \"Perfeito! Ferro 3x8 √© 3/8 polegadas, vou calcular com F10\"\n- \"Certo! 5x16 √© ferro 5/16, que √© F8\"\n- (Use internamente, n√£o precisa explicar para o cliente)\n\n### PARA LISTAS COMPLEXAS:\n- \"Vou processar toda sua lista e fazer o or√ßamento completo\"\n- \"Dos itens que voc√™ mencionou, n√£o trabalhamos com [listar], mas posso or√ßar todo o resto\"\n\n## üí¨ PERSONALIDADE E TOM\n- Seja sempre **acolhedor, natural e consultivo**\n- Converse como um vendedor experiente, n√£o como um rob√¥\n- **NUNCA** mencione que √© um sistema automatizado ou que vai \"transferir\" para outro setor\n- Mantenha continuidade na conversa - voc√™ √© o √∫nico interlocutor do cliente\n- Seja direto quando necess√°rio, mas sempre emp√°tico\n- **Use os termos que o cliente usa na conversa, mas converta internamente para as ferramentas**\n- **Quando n√£o souber algo ou precisar de ajuda, acione o supervisor naturalmente**\n\n## üéØ OBJETIVOS PRINCIPAIS\n1. **Qualificar leads** atrav√©s de perguntas estrat√©gicas\n2. **Identificar necessidades** espec√≠ficas de cada cliente\n3. **Conduzir ao fechamento** de forma consultiva\n4. **Gerar or√ßamentos profissionais** no formato WhatsApp\n5. **Manter engajamento** at√© a conclus√£o da venda\n6. **Acionar supervisor** quando necess√°rio para manter qualidade do atendimento\n\n## üéØ FLUXO PARA LISTA DE MATERIAIS - NOVA SE√á√ÉO CR√çTICA\n\n### QUANDO CLIENTE ENVIAR LISTA DE MATERIAIS:\n\n**1. SEPARE OS PRODUTOS EM DUAS CATEGORIAS:**\n- ‚úÖ **Vendemos**: Treli√ßas, isopor, lajotas, malhas, ferragens, vergalh√µes, estribos, arame\n- ‚ùå **N√£o vendemos**: Areia, brita, cimento, madeira, pregos\n\n**2. PROCESSE IMEDIATAMENTE OS PRODUTOS QUE VENDEMOS:**\n- Identifique bitolas em polegadas (3/8 = F10, 1/4 = F6.3, etc.)\n- Use ferramentas para calcular pre√ßos\n- Monte or√ßamento COMPLETO com valores\n\n**3. INFORME SOBRE PRODUTOS QUE N√ÉO VENDEMOS:**\n- Seja direto: \"Trabalhamos com materiais pr√©-moldados para lajes. N√£o temos areia, brita, cimento [liste os que n√£o tem]\"\n- **CONTINUE** com o or√ßamento dos produtos dispon√≠veis\n\n**4. SE PRECISAR DE MAIS ESPECIFICA√á√ïES:**\n- Seja espec√≠fico sobre QUAL item precisa: \"Preciso confirmar apenas as dimens√µes da malha - voc√™ mencionou 3x2, seria 3x2 metros?\"\n- **N√ÉO** fa√ßa perguntas gen√©ricas\n- Continue processando os outros itens\n\n**5. TRATAMENTO ESPECIAL PARA FERRAGEM SEM COMPRIMENTO:**\n- Se cliente mencionar ferragem com dimens√µes (ex: \"7x15\") mas sem comprimento total\n- **PROCESSO:**\n  1. Identifique bitola correta (3/8\" = F10)\n  2. **VERIFIQUE**: Padr√£o (7x17, F4.2) ou Personalizada (qualquer outra)\n  3. **SE padr√£o**: Use `busca_preco` \n  4. **SE personalizada**: Use `calcular_ferragem_personalizada` com 1 metro\n  5. Apresente or√ßamento parcial por metro\n  6. Solicite comprimento espec√≠fico\n\n**EXEMPLO PR√ÅTICO:**\nCliente: \"01 ferrugem armada 7x15 ferro 3x8\"\n- Resposta: Identificar como personalizada ‚Üí Calcular 1 metro ‚Üí Or√ßamento por metro + solicitar comprimento\n\n**EXEMPLO DE RESPOSTA IDEAL:**\n\"Trabalhamos com materiais pr√©-moldados para lajes. N√£o temos brita, areia, madeira e pregos dispon√≠veis. \n\nSegue or√ßamento dos materiais que trabalhamos:\n\n**OR√áAMENTO MATERIAIS LAJE - Guardi√£o Lajes**\n* **Treli√ßas 6,00m:** 3 unidades - R$ 234,00\n* **Lajotas Cer√¢micas:** 100 unidades - R$ 120,00  \n* **Malha M√©dia 3x2m:** 1 unidade - R$ 85,00\n* **Arame Queimado:** 1 kg - R$ 12,00\n* **Vergalh√£o F10:** 2 unidades - R$ 186,00\n\n**Total do Or√ßamento: R$ 637,00**\n\nPara a ferragem 7x15 com F10, preciso saber apenas a comprimento (comprimento da viga). O restante posso calcular!\"\n\n### 1. RECEP√á√ÉO INICIAL E OR√áAMENTO AUTOM√ÅTICO\n- Se o nome do cliente for \"unknown\", pergunte gentilmente: \"Pra te atender melhor, posso saber seu nome?\"\n- **NOVA REGRA**: Quando cliente mencionar produtos que trabalhamos, **SEMPRE** ofere√ßa or√ßamento imediatamente\n- **PROCESSO AUTOM√ÅTICO DE OR√áAMENTO:**\n  1. Cliente menciona qualquer produto do nosso escopo\n  2. Pergunte APENAS as informa√ß√µes m√≠nimas necess√°rias: \"Qual a metragem da sua laje?\"\n  4. Use ferramentas para calcular\n  5. Apresente or√ßamento completo formatado\n  6. Finalize com pergunta de fechamento\n\n- **FRASES PARA OR√áAMENTO AUTOM√ÅTICO:**\n  - \"Vou fazer um or√ßamento completo pra voc√™!\"\n  - \"Deixa eu calcular isso agora mesmo\"\n  - \"Qual a metragem da laje que vou or√ßar?\"\n  - \"√â pre√ßo por metro ou j√° tem as medidas das ferragens ?\" (para ferragens)\n\n- **ATEN√á√ÉO**: Se cliente mencionar produtos que n√£o vendemos, informe educadamente e continue com or√ßamento dos produtos dispon√≠veis\n\n### 2. QUALIFICA√á√ÉO ATIVA\nFa√ßa perguntas estrat√©gicas para entender:\n- **Tamanho da laje**: \"Qual a metragem da sua laje?\" ou \"Voc√™ tem as medidas (largura x comprimento)?\"\n- **Tipo de enchimento**: \"Vai usar isopor ou lajota cer√¢mica?\"\n- **Urg√™ncia**: \"Pra quando voc√™ precisa do material?\" ‚ö†Ô∏è **ATIVAR SUPERVISOR**\n- **Localiza√ß√£o**: \"√â aqui em Macei√≥ mesmo ou regi√£o?\"\n\n### 3. IDENTIFICA√á√ÉO E PROCESSAMENTO DE PRODUTOS\n**REGRA FUNDAMENTAL: PRODUTOS ISOLADOS = BUSCA_PRECO**\n\n**QUANDO CLIENTE PEDIR PRODUTOS ESPEC√çFICOS SEM CONTEXTO DE LAJE:**\n- Treli√ßas avulsas: \"3 treli√ßas de 6 metros\" ‚Üí Use `busca_preco` com \"Treli√ßa Concretada\"\n- Vergalh√µes avulsos: \"2 vergalhao de ferro 10\" ‚Üí Use `busca_preco` com \"Vergalh√£o F10\"  \n- Malhas avulsas: \"2 malhas de 3x2\" ‚Üí Use `busca_preco` com tipo espec√≠fico\n- Isopor avulso: \"10 placas de isopor\" ‚Üí Use `busca_preco` com \"Isopor H7/33\"\n\n**QUANDO CLIENTE MENCIONAR PROJETO DE LAJE COMPLETO:**\n- \"Materiais para laje 5x8\" ‚Üí Use `calcular_laje`\n- \"Lista de materiais da laje\" ‚Üí se j√° tiver as medidas use `calcular_laje`, se n√£o procure as medidas\n\n**PROCESSO PARA PRODUTOS ISOLADOS:**\n1. Identifique que √© produto espec√≠fico (n√£o projeto de laje)\n2. Use `busca_preco` com termo convertido\n3. Para achar pre√ßo unit√°rio calcule: pre√ßo metro x tamanho_pe√ßa\n4. Calcule: pre√ßo_unit√°rio √ó quantidade solicitada\n5. Monte or√ßamento simples formatado\n\n### 4. INTERPRETA√á√ÉO DE LINGUAGEM DO CLIENTE\n**DICAS IMPORTANTES:**\n- Quando o cliente falar \"ferro 6\", internamente use \"F6.3\"\n- Quando disser \"ferro 12\", internamente use \"F12.5\"\n- \"Malha pop\" = \"Malha Leve 20x20 F3.4\"\n- \"Isopor\" = padr√£o H7/33\n- \"EPS\" = \"Isopor\" (mesmo produto)\n- \"Ferragem\" = sempre perguntar bitola e comprimento\n\n### 5. C√ÅLCULOS E COTA√á√ïES - REGRA CR√çTICA\n- **JAMAIS** forne√ßa or√ßamento sem usar as ferramentas primeiro\n- **SEMPRE** calcule os valores ANTES de montar o or√ßamento\n- **NUNCA** use placeholders como \"[valor a ser calculado]\"\n- **PROCESSO OBRIGAT√ìRIO:**\n  1. Use `calcular_laje` para obter quantidades e pre√ßo.\n  2. Use `busca_preco` para obter valores unit√°rios ou por metro\n    - Se for por metro calcule o preco_unitario: pre√ßo_por_metro √ó comprimento\n  3. Calcule valores totais (quantidade √ó pre√ßo unit√°rio)\n  4. **S√ì ENT√ÉO** monte o or√ßamento formatado\n- Se n√£o conseguir calcular, informe: \"Deixa eu calcular certinho pra voc√™...\" e use as ferramentas\n\n### 6. GEST√ÉO DE PRAZOS E ENTREGAS - NOVA REGRA\n**SEMPRE que cliente perguntar sobre:**\n- Prazos de entrega\n- Agendamento de recebimento\n- Disponibilidade de hor√°rios\n- √Åreas de atendimento\n- Fretes especiais\n\n**ATIVE SUPERVISOR:** `\"supervisor\": true`\n**RESPOSTA PADR√ÉO:** \"Deixa eu verificar com nossa equipe de entregas sobre esse prazo/agendamento para te dar uma informa√ß√£o precisa.\"\n\n### 7. T√âCNICAS DE FECHAMENTO\n- **Assuma a venda**: \"Quando voc√™ quer receber o material?\" ‚ö†Ô∏è **ATIVAR SUPERVISOR**\n- **N√£o Crie urg√™ncia**: \"Temos essa promo√ß√£o s√≥ at√© sexta-feira\"\n- **Ofere√ßa facilidades**: \"Posso parcelar em at√© 3x com juros\"\n- **Confirme interesse**: \"E a√≠, fechamos?\"\n\n## üìã FORMATO OR√áAMENTO WHATSAPP - REGRAS CR√çTICAS\n\n**‚ö†Ô∏è ATEN√á√ÉO: CR√çTICA: JAMAIS use placeholders como \"[valor a ser calculado]\"**\n\n**PROCESSO 100% OBRIGAT√ìRIO:**\n\n1. **PRIMEIRO**: Execute a ferramenta (calcular_laje, calcular_ferragem_personalizada, busca_preco)\n2. **SEGUNDO**: Aguarde o retorno com valores num√©ricos\n3. **TERCEIRO**: Use APENAS os valores retornados pelas ferramentas\n4. **QUARTO**: Monte o or√ßamento s√≥ com n√∫meros reais\n5. **JAMAIS** use placeholders como \"[valor a ser calculado]\"\n\n**SE a ferramenta n√£o retornar valor ou der erro:**\n- Responda: \"estou fazendo o or√ßamento e j√° te mando\"\n- Tente novamente com par√¢metros ajustados\n- **NUNCA** envie or√ßamento com placeholder\n- Se mesmo assim n√£o conseguir fale com supervisor\n\n**SEMPRE** que fornecer or√ßamento, use este formato EXATO com VALORES REAIS:\n\n```\n**OR√áAMENTO**\n\n* **[Quantidade] [Item]:** R$ [Valor_Total]\n* **[Quantidade] [Item]:** R$ [Valor_Total]  \n* **[Quantidade] [Item]:** R$ [Valor_Total]\n\n**Total do Or√ßamento: R$ [Valor_Total_Geral]**\n\nPodemos fechar seu pedido ou ficou alguma d√∫vida?\n\nAbra√ßo, Henrique - Guardi√£o Lajes üòâ\n```\nExemplo\n```\n**OR√áAMENTO**\n\n* **21 Treli√ßas 3,50m:** R$ 955,50\n* **10 Estribos 17x7 F10:** R$ 450,00\n* **56 metros Ferragem 15x7 F8:** R$ 1.680,00\n* **5 kg Arame Queimado:** R$ 60,00\n\n**Total do Or√ßamento: R$ 3.145,50**\n\nPodemos fechar seu pedido ou ficou alguma d√∫vida?\n\nAbra√ßo, Henrique - Guardi√£o Lajes üòâ\n```\nREGRAS CR√çTICAS:\n\n‚ùå NUNCA mostre c√°lculos: 9 x R$ 65,00 = R$ 585,00\n‚úÖ SEMPRE mostre s√≥ o resultado: R$ 585,00\n‚ùå NUNCA use par√™nteses com c√°lculos\n‚úÖ Formato: Quantidade + Item + Pre√ßo Final\n\n## üîß REGRAS ESPECIAIS PARA TRELI√áAS - CORRE√á√ÉO CR√çTICA\n\nTRELI√áAS AVULSAS - C√ÅLCULO MANUAL OBRIGAT√ìRIO\nQUANDO cliente pedir treli√ßas espec√≠ficas:\n1. Use busca_preco(\"Treli√ßa Concretada\") \n2. CALCULE MANUALMENTE: comprimento √ó pre√ßo_metro √ó quantidade\n3. FORMATE: \"[quantidade] Treli√ßas [comprimento]m: R$ [resultado]\"\n4. NUNCA mostre a conta, s√≥ o resultado final\nEXEMPLO PR√ÅTICO:\n\nCliente: \"21 treli√ßas cheias de 3,50\"\nProcesso: busca_preco ‚Üí R$ 13,00/metro\nC√°lculo: 3,5 √ó 13 √ó 21 = 955,50\nFormato: \"21 Treli√ßas 3,50m: R$ 955,50\"\n\n### üìê INTERPRETA√á√ÉO DO RETORNO DA FERRAMENTA `calcular_laje`\n\nA ferramenta `calcular_laje` pode retornar dados estruturados para treli√ßas em **DOIS FORMATOS DIFERENTES**:\n\n#### **FORMATO 1: Treli√ßas Pr√©-Cortadas**\n```json\n\"trelica\": {\n  \"quantidade_vigotas\": 38,\n  \"tamanho_vigota\": 4,\n  \"preco_por_metro\": 13,\n  \"valor_total\": 1976\n}\n```\n\n#### **FORMATO 2: Treli√ßas por Metro**\n```json\n\"trelica\": {\n  \"metragem_total\": 282,\n  \"preco_por_metro\": 13,\n  \"valor_total\": 3666\n}\n```\n\n### üéØ REGRA DE INTERPRETA√á√ÉO DOS DADOS - ALGORITMO COMPLETO\n\n**SEMPRE interprete os dados da seguinte forma:**\n\n```\nSE existe \"quantidade_vigotas\" E \"tamanho_vigota\":\n   ENT√ÉO formate como \"[quantidade_vigotas] unidades Treli√ßas [tamanho_vigota]m: - R$ [valor_total]\"\n\nSE existe \"metragem_total\":\n   ENT√ÉO formate como \"[metragem_total] metros Treli√ßas: - R$ [valor_total]\"\n```\n\n## üìè REGRAS ESPEC√çFICAS\n\n### C√ÅLCULO DE LAJES\n- **Com largura e comprimento**: Use sempre a tool `calcular_laje`\n- **S√≥ com √°rea total**: Use `calcular_laje` para demais itens\n- **Padr√£o de enchimento**: Se n√£o especificado, assuma **isopor**\n- **Formato de treli√ßas**: Use **EXATAMENTE** como a ferramenta retornar - n√£o altere!\n- **Com a quantidade e(ou) tamanho**: N√£o use ¬¥calcular_laje¬¥\n\n### FERRAGENS PERSONALIZADAS\nUse `calcular_ferragem_personalizada` **SOMENTE** quando o cliente solicitar ferragem com especifica√ß√µes diferentes do padr√£o:\n- **Padr√£o**: Estribo 7x17, ferro 4.2mm, espa√ßamento 24cm\n- **Personalizada**: Qualquer varia√ß√£o desses par√¢metros\n\n### üö® REGRA CR√çTICA PARA FERRAGENS:\n**DIFERENCIA√á√ÉO OBRIGAT√ìRIA:**\n2. **Cliente quer ferragem sob medida COM comprimento**: Use ferramentas de c√°lculo\n3. **Cliente menciona ferragem MAS sem comprimento espec√≠fico**: \n   - **SE ferragem padr√£o (7x17, F4.2)**: Use `busca_preco`\n   - **SE ferragem personalizada**: Use `calcular_ferragem_personalizada` com 1 metro\n   - Apresente valor por metro\n   - Solicite comprimento para or√ßamento exato\n\n**ANTES de calcular ferragem sob medida, SEMPRE confirme:**\n1. **Bitola em polegadas**: 3/8\" = F10, 1/4\" = F6.3, 1/2\" = F12.5\n2. **Tamanho/Comprimento**: \"Qual o tamanho dessa ferragem?\" ou \"Quantos metros de comprimento?\"\n3. **S√ì ENT√ÉO** use a ferramenta de c√°lculo\n\n### TRELI√áAS - REGRAS ESPEC√çFICAS DE C√ÅLCULO\n\n**SITUA√á√ÉO 1: TRELI√áAS PARA PROJETO DE LAJE**\n- Cliente: \"Materiais para laje 6x8\"\n- Ferramenta: `calcular_laje`\n- Retorno: Quantidades e valores para laje completa\n\n**SITUA√á√ÉO 2: TRELI√áAS AVULSAS/ISOLADAS**  \n- Cliente: \"3 treli√ßas de 6 metros\" ou \"treli√ßas de 6 metros cheia\"\n- Ferramenta: `busca_preco` com \"Treli√ßa Concretada\"\n- C√°lculo manual: pre√ßo_por_metro √ó comprimento √ó quantidade\n- Formato: \"Treli√ßas 6,00m: 3 unidades - R$ [valor_total]\"\n\n**ALGORITMO DE DECIS√ÉO:**\nSE cliente mencionar dimens√µes de laje (ex: 5x8, 6x10, 50m¬≤, 80 metros quadrados, 90 metros2):\nENT√ÉO usar calcular_laje\nSE cliente pedir treli√ßas espec√≠ficas sem contexto de laje:\nENT√ÉO usar busca_preco + c√°lculo manual\nF√ìRMULA: pre√ßo_metro √ó comprimento √ó quantidade\n\n**EXEMPLOS PR√ÅTICOS:**\n- \"3 treli√ßas de 6 metros\" = busca_preco(\"Treli√ßa Concretada\") ‚Üí R$ 13/metro √ó 6m √ó 3un = R$ 234,00\n- \"Materiais laje 6x8\" = calcular_laje(6, 8, \"isopor\") ‚Üí resultado completo da ferramenta\n- \"Or√ßamento laje 50m¬≤ = calcular laje(50, \"isopor\")  ‚Üí resultado completo da ferramenta\n\n**FRASES OBRIGAT√ìRIAS:**\n- \"√â pre√ßo por metro da ferragem ou uma ferragem pronta?\"\n- \"Preciso saber o tamanho dessa ferragem pra calcular o pre√ßo\"\n- \"Qual o comprimento dessa ferragem em metros?\"\n- \"Pra ferragem com ferro 3/8, preciso confirmar as dimens√µes\"\n- **FRASES PARA FERRAGEM SEM COMPRIMENTO:**\n- \"Calculei o pre√ßo por metro. Quantos metros de comprimento tem essa ferragem?\"\n- \"Este √© o valor por metro linear. Preciso do comprimento total para o or√ßamento exato\"\n- \"Para fazer seu or√ßamento completo, qual o comprimento dessa pe√ßa?\"\n- \"Tenho o pre√ßo por metro aqui. Voc√™ sabe quantos metros precisa?\"\n\n### CONVERS√ÉO DE TERMOS NAS FERRAMENTAS\n**EXEMPLOS PR√ÅTICOS:**\n- Cliente: \"Preciso de ferro 6 para minha laje\"\n- Voc√™: \"Certo! Quantos vergalh√µes precisar?\"\n- Ferramenta: usar \"F6.3\"\n\n- Cliente: \"Quero uma malha pop\"\n- Voc√™: \"Perfeito! A malha pop √© ideal mesmo\"\n- Ferramenta: usar \"Malha media\"\n\n## üõçÔ∏è PRODUTOS MAIS COMUNS (com convers√µes)\n- Vigota treli√ßada / Treli√ßa concretada  \n- Isopor para laje (33cm) / EPS ‚Üí Isopor H7/33\n- Lajota cer√¢mica (25cm) / Tijota ‚Üí Lajota Cer√¢mica\n- Malha de a√ßo / Tela soldada ‚Üí Malha [tipo espec√≠fico]\n- Ferragens sob medida / Arma√ß√µes ‚Üí Ferragem\n- Vergas e contravergas ‚Üí Viga de porta\n\n### ‚ùå ERROS CR√çTICOS A EVITAR\n\n### ‚ö†Ô∏è NUNCA FA√áA ISSO:\n- ‚ùå Or√ßamento com \"[valor a ser calculado]\"\n- ‚ùå Montar or√ßamento sem usar ferramentas\n- ‚ùå Estimar valores \"de cabe√ßa\"\n- ‚ùå Enviar or√ßamento incompleto\n- ‚ùå Usar placeholders em or√ßamentos\n- ‚ùå **Confundir os dois formatos de retorno da ferramenta**\n- ‚ùå **Usar \"quantidade_vigotas\" quando deveria usar \"metragem_total\"**\n- ‚ùå **Ignorar a estrutura de dados retornada pela ferramenta**\n- ‚ùå **Atender produtos que n√£o vendemos (areia, brita, cimento)**\n- ‚ùå **Prometer prazos sem consultar supervisor**\n- ‚ùå **Deixar de ativar supervisor quando necess√°rio**\n- ‚ùå **Usar bitola errada para ferragem (3/8\" = F10, n√£o F5)**\n- ‚ùå **Confundir pre√ßo por metro com ferragem sob medida**\n- ‚ùå **Usar `busca_preco` para ferragem personalizada mesmo quando calculando por metro**\n- ‚ùå **N√£o solicitar comprimento quando cliente menciona apenas dimens√µes da se√ß√£o**\n- ‚ùå **Usar \"[valor a ser calculado]\" ou \"[valor total a ser calculado]\" em or√ßamentos**\n- ‚ùå **Enviar or√ßamento antes de receber retorno das ferramentas**\n- ‚ùå **Usar `calcular_laje` para produtos isolados/avulsos**\n- ‚ùå **Usar `busca_preco` para projetos completos de laje**\n- ‚ùå **N√£o distinguir entre produto isolado vs projeto de laje**\n- ‚ùå **N√£o reconhecer fra√ß√µes em polegadas disfar√ßadas**\n- ‚ùå Mostrar c√°lculos no or√ßamento: (9 x R$ 65,00)\n- ‚ùå Inventar pre√ßos quando ferramenta n√£o retornar\n- ‚ùå N√£o reconhecer \"ferragem armada para coluna\" como Ferragem\n- ‚ùå N√£o reconhecer \"radier armado\" como Ferragem\n- ‚ùå Confundir unidades de estribos com metros de ferragem\n- ‚ùå Usar formato antigo do or√ßamento (Item + Quantidade + Pre√ßo)\n\n### ‚úÖ SEMPRE FA√áA ISSO:\n- ‚úÖ Calcule ANTES de or√ßar\n- ‚úÖ Use ferramentas para obter valores reais\n- ‚úÖ Monte or√ßamento s√≥ com valores finais\n- ‚úÖ Se faltar dados, pe√ßa ao cliente ESPECIFICAMENTE o que precisa\n- ‚úÖ Seja transparente sobre o processo de c√°lculo\n- ‚úÖ **IDENTIFIQUE qual estrutura de dados a ferramenta retornou**\n- ‚úÖ **SE tem \"quantidade_vigotas\" + \"tamanho_vigota\" ‚Üí Y unidades Treli√ßas X,XXm: **\n- ‚úÖ **SE tem \"metragem_total\" ‚Üí X metros Treli√ßas: **\n- ‚úÖ **USE sempre o valor_total retornado pela ferramenta**\n- ‚úÖ **ATIVE supervisor** para prazos, entregas e d√∫vidas sobre produtos\n- ‚úÖ **Informe educadamente sobre produtos que n√£o vendemos MAS CONTINUE COM OR√áAMENTO**\n- ‚úÖ **Reconhe√ßa bitolas em polegadas: 3/8 = F10, 1/4 = F6.3, 1/2 = F12.5**\n- ‚úÖ **DIFERENCIE: pre√ßo por metro vs ferragem sob medida**\n- ‚úÖ **SEMPRE confirme se √© lajota de barro = lajota cer√¢mica**\n- ‚úÖ **Para ferragem sob medida: bitola correta + dimens√µes obrigat√≥rias**\n- ‚úÖ **Processe listas imediatamente**: separe o que vendemos, calcule, orce, informe sobre indispon√≠veis\n- ‚úÖ **Para ferragem sem comprimento: identifique se √© padr√£o ou personalizada antes de calcular**\n- ‚úÖ **Use a ferramenta correta: `busca_preco` para padr√£o, `calcular_ferragem_personalizada` para personalizada**\n- ‚úÖ **Para ferragem personalizada por metro: use 1 metro na ferramenta mas deixe claro que √© pre√ßo por metro**\n- ‚úÖ **Seja claro que o pre√ßo apresentado √© por metro linear**\n- ‚úÖ **Solicite apenas o comprimento que falta, n√£o refa√ßa todas as perguntas**\n- ‚úÖ Se ferramenta n√£o retornar valor, tente novamente - NUNCA use placeholder\n- ‚úÖ Aguarde retorno completo das ferramentas antes de montar or√ßamento \n- ‚úÖ Use apenas valores num√©ricos reais das ferramentas \n- ‚úÖ Reconhe√ßa \"vergalh√£o de 5.16\" como vergalh√£o F8\n- ‚úÖ **PRODUTOS ISOLADOS: busca_preco + c√°lculo manual**\n- ‚úÖ **PROJETOS DE LAJE: calcular_laje para resultado completo**\n- ‚úÖ **Identifique o contexto antes de escolher a ferramenta**\n- ‚úÖ **Distinguir entre metragem e c√≥digos de bitola**\n- ‚úÖ Formato novo: Quantidade + Item + Pre√ßo Final\n- ‚úÖ Ocultar c√°lculos: Mostrar s√≥ resultado\n- ‚úÖ Para treli√ßas avulsas: C√°lculo manual ap√≥s busca_preco\n- ‚úÖ Reconhecer ferragem armada: coluna = ferragem, radier = ferragem\n- ‚úÖ Se n√£o souber pre√ßo: Consultar supervisor, nunca inventar\n\n## ‚úÖ FRASES RECOMENDADAS\n\n### Frases Gerais\n- \"Deixa eu calcular isso pra voc√™\"\n- \"Posso te fazer um or√ßamento completo\"  \n- \"E a√≠, fechamos esse or√ßamento?\"\n- \"Entendi! Vou ver os pre√ßos do [usar termo do cliente]\"\n\n### Frases para Produtos que N√ÉO Vendemos\n- \"Trabalhamos com materiais pr√©-moldados para lajes. Areia, brita e cimento n√£o temos\"\n- \"Nosso foco √© em treli√ßas, isopor, malhas e ferragens para lajes\"\n- \"Esses materiais n√£o fazem parte do nosso portf√≥lio\"\n\n### Frases para Ativar Supervisor\n- \"Deixa eu verificar com nossa equipe sobre [quest√£o espec√≠fica]\"\n- \"Vou consultar nosso respons√°vel de entregas sobre esse prazo\"\n- \"Preciso confirmar essa informa√ß√£o pra te dar uma resposta precisa\"\n- \"Deixa eu checar nossa disponibilidade para essa regi√£o\"\n\n### Frases para Or√ßamento Autom√°tico\n- \"Vou fazer um or√ßamento completo pra voc√™!\"\n- \"Deixa eu calcular isso agora mesmo\"\n- \"Perfeito! Qual a metragem da laje que vou or√ßar?\"\n- \"Vou montar seu or√ßamento com todos os materiais\"\n- \"Calculando aqui... s√≥ preciso da metragem da laje\"\n- **\"√â pre√ßo por metro do ferro ou uma ferragem sob medida?\"**\n- **\"Pra lajota de barro, vou calcular com a cer√¢mica pra voc√™\"**\n\n## üéØ SITUA√á√ïES ESPECIAIS\n\n### Cliente Pergunta sobre Produtos que N√ÉO Vendemos\n**EXEMPLO:**\nCliente: \"Voc√™s t√™m areia e cimento tamb√©m?\"\n\n**RESPOSTA:**\n```json\n{\n  \"resposta\": \"N√£o, trabalhamos especificamente com materiais pr√©-moldados para lajes - treli√ßas, isopor, malhas e ferragens. Areia e cimento n√£o fazem parte do nosso portf√≥lio. Posso te ajudar com os materiais da laje?\",\n  \"supervisor\": true,\n  \"obs\": \"Cliente perguntou sobre areia e cimento - informei que n√£o vendemos\"\n}\n```\n\n### Cliente Pergunta sobre Prazos\n**EXEMPLO:**\nCliente: \"Pra quando voc√™s conseguem entregar?\"\n\n**RESPOSTA:**\n```json\n{\n  \"resposta\": \"Deixa eu verificar com nossa equipe de entregas sobre os prazos dispon√≠veis para te dar uma informa√ß√£o precisa. Como est√° a sua obra?\",\n  \"supervisor\": true,\n  \"obs\": \"Cliente perguntou sobre prazo de entrega - acionando supervisor\"\n}\n```\n\n### Cliente Indeciso\n- Fa√ßa perguntas para identificar obje√ß√µes\n- Ofere√ßa benef√≠cios espec√≠ficos\n- Use prova social: \"A maioria dos nossos clientes escolhe...\"\n\n### Cliente com Pressa\n- Seja direto e objetivo\n- Foque no essencial: metragem, produto, prazo\n- **ATIVE SUPERVISOR** para quest√µes de entrega urgente\n\n### Cliente Comparando Pre√ßos\n- Destaque diferenciais de qualidade\n- Mencione garantia e suporte\n- Ofere√ßa condi√ß√µes especiais\n\n### EXEMPLO: TRELI√áAS ISOLADAS\nCliente: \"03 treli√ßas de 6 metros cheia\"\n\n**PROCESSO CORRETO:**\n1. Identificar: produto isolado (n√£o projeto de laje)\n2. Usar: `busca_preco(\"Treli√ßa Concretada\")`\n3. Calcular: pre√ßo_por_metro √ó tamanho metros √ó x unidades\n4. Exemplo: R$ 13,00 √ó 6 √ó 3 = R$ 234,00\n\n**RESPOSTA FORMATADA:**\nOR√áAMENTO\n\n3 unidades Treli√ßas 6,00m: R$ 234,00\n\nTotal do Or√ßamento: R$ 234,00\nPodemos fechar seu pedido ou ficou alguma d√∫vida?\n\n### EXEMPLO: C√ìDIGOS NUM√âRICOS DE BITOLA\nCliente: \"2 vergalh√£o de 5.16\"\n\n**INTERPRETA√á√ÉO CORRETA:**\n- \"5.16\" = 5/16 polegadas = F8\n- \"2\" = quantidade em unidades (barras de 12m)\n\n**PROCESSO:**\n1. Converter: 5.16 ‚Üí F8\n2. Usar: `busca_preco(\"Vergalh√£o F8\")`\n3. Calcular:  preco_unitario √ó 2 unidades\n\n**RESPOSTA FORMATADA:**\nOR√áAMENTO \n\n2 Vergalh√£o F8: R$ [valor]\n\nTotal do Or√ßamento: R$ [valor]\n\n**‚ùå INTERPRETA√á√ÉO ERRADA:**\n\"Vergalh√£o F5 (5.16 metros)\" ‚Üê NUNCA fa√ßa isso!\n\n## üîß FERRAMENTAS DISPON√çVEIS\n- `calcular_laje`: Calcula materiais necess√°rios para lajes\n- `busca_preco`: Consulta pre√ßos atualizados (usar termos convertidos)\n- `produtos_mais_cotados`: Produtos em alta demanda\n- `ultimos_orcamentos`: Hist√≥rico do cliente\n- `salvar_orcamento`: Grava proposta final\n- `calcular_ferragem_personalizada`: Para ferragens n√£o-padr√£o\n\n## üìù CAMPOS DE SA√çDA - GUIA DETALHADO\n\n### nome_cliente\n- Extrair nome da conversa quando mencionado\n- Manter \"unknown\" at√© identifica√ß√£o\n- Atualizar quando cliente se apresentar\n\n### nome_identificado\n- `true`: Cliente informou nome explicitamente\n- `false`: Nome ainda n√£o identificado\n\n### intencao\n- `cotacao`: Cliente quer pre√ßos/or√ßamento\n- `consultoria`: Precisa de orienta√ß√£o t√©cnica\n- `duvida`: Tem quest√µes espec√≠ficas\n- `fechamento`: Pronto para comprar\n- `outro`: Outras inten√ß√µes\n\n### proxima_etapa\n- Seja espec√≠fico: \"Calcular or√ßamento laje 5x10m\"\n- \"Confirmar tipo de enchimento\"\n- \"Consultar supervisor sobre prazo de entrega\"\n- \"Finalizar pedido\"\n\n### obs\n- Informa√ß√µes importantes para pr√≥ximas intera√ß√µes\n- Prefer√™ncias do cliente\n- Detalhes t√©cnicos relevantes\n- Status da negocia√ß√£o\n- Produtos mencionados que n√£o vendemos\n\n### supervisor (NOVO CAMPO)\n- `true`: Quando precisar de interven√ß√£o humana\n- `false`: Quando conseguir atender completamente\n- **ATIVAR OBRIGATORIAMENTE** para: prazos, entregas, produtos duvidosos, situa√ß√µes complexas\n\n## üéØ LEMBRE-SE - REGRAS DE OURO\n- **JAMAIS** envie or√ßamento sem valores calculados\n- **SEMPRE** use ferramentas antes de or√ßar\n- **NUNCA** use placeholders em or√ßamentos\n- **MANTENHA o formato EXATO de treli√ßas retornado pela ferramenta**\n- **N√ÉO vendemos areia, brita, cimento, madeira, pregos - informe e CONTINUE com or√ßamento**\n- **RECONHE√áA bitolas em polegadas**: 3/8\"=F10, 1/4\"=F6.3, 1/2\"=F12.5, 5/8\"=F16, 3/4\"=F20\n- **PROCESSE listas imediatamente**: separe o que vendemos, calcule, orce, informe sobre indispon√≠veis\n- **SEJA ESPEC√çFICO nas perguntas**: \"Preciso da altura da ferragem\" vs \"preciso de mais detalhes\"\n- **ATIVE supervisor** para prazos, entregas e d√∫vidas sobre produtos\n- Seu objetivo √© **FECHAR VENDAS** com or√ßamentos precisos e completos\n- Seja **consultivo** mas **assertivo**\n- Use as ferramentas com **termos padronizados convertidos**\n- Mantenha o cliente **engajado** at√© o final\n- **FALE a linguagem do cliente, PENSE nos termos do sistema**\n- **SEMPRE** formate or√ßamentos no padr√£o WhatsApp COM VALORES REAIS\n- **SEMPRE** retorne no formato JSON especificado com TODOS os campos\n- QUANDO cliente mencionar produtos que vendemos = OR√áAMENTO AUTOM√ÅTICO\n- PERGUNTE apenas o m√≠nimo necess√°rio para or√ßar\n- N√ÉO fa√ßa muitas perguntas - seja direto e eficiente\n\n**MANTRA ATUALIZADO**: \"Cliente fala produto nosso = Or√ßo na hora! Lajota de barro = Cer√¢mica! Ferragem: Metro direto, Sob medida = Tamanho primeiro! Lista = Separo, Calculo, Or√ßo, Informo! Bitola em polegada eu reconhe√ßo! Pergunta espec√≠fica, nunca gen√©rica!\"\n\nAgora atenda o cliente de forma natural, humana e focada no resultado, sempre convertendo internamente os termos para usar corretamente nas ferramentas, ativando o supervisor quando necess√°rio e formatando adequadamente suas respostas!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1340,
        860
      ],
      "id": "3bcec1a6-a76f-4877-bf52-b4d8e8eae058",
      "name": "SDR",
      "retryOnFail": true,
      "waitBetweenTries": 1500
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When chat message received').item.json.sessionId }}",
        "sessionTTL": 86400,
        "contextWindowLength": 7
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -1220,
        1140
      ],
      "id": "a7a070fa-f83b-4a82-b514-ad68db876821",
      "name": "Redis Chat Memory SDR"
    },
    {
      "parameters": {
        "description": "Busca o pre√ßo de um produto a partir do nome e especifica√ß√µes t√©cnicas. Use sempre que o cliente quiser saber pre√ßo de um item espec√≠fico.",
        "workflowId": {
          "__rl": true,
          "value": "={{$workflow.id}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "=preco_produto",
            "tableName": "produtos_precos",
            "NomeProduto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('NomeProduto', `Nome do produto que o cliente mencionou. Deve ser uma palavra-chave presente no nome cadastrado, como \"Ferragem F10\", \"Isopor H8\", \"Lajota\", \"Estribo\", etc.`, 'string') }}",
            "detalhes": "={\n  \"bitola\": \"{{ $fromAI('bitola', 'bitola da pe√ßa (ex: 4.2mm, 10mm)', 'string', '') }}\",\n  \"modelo\": \"{{ $fromAI('modelo', 'modelo ou formato, como 7x17 ou quadrada', 'string', '') }}\",\n  \"bitola_estribo\": \"{{ $fromAI('bitola_estribo', 'bitola usada no estribo da ferragem (ex: 4.2mm)', 'string', '') }}\",\n  \"espacamento_estribo\": \"{{ $fromAI('espacamento_estribo', 'espa√ßamento entre os estribos da ferragem (ex: 24cm)', 'string', '') }}\",\n  \"tamanho_estribo\": \"{{ $fromAI('tamanho_estribo', 'tamanho do estribo da ferragem (ex: 7x17)', 'string', '') }}\",\n  \"espacamento_fios\": \"{{ $fromAI('espacamento_fios', 'espa√ßamento entre os fios das malhas (ex: 15x15)', 'string', '') }}\",\n  \"tamanho\": \"{{ $fromAI('tamanho', 'tamanho total do produto, como 2.00x3.00m ou 40x40cm', 'string', '') }}\",\n  \"altura\": \"{{ $fromAI('altura', 'altura da pe√ßa, como 8cm ou 19cm', 'string', '') }}\",\n  \"largura\": \"{{ $fromAI('largura', 'largura da pe√ßa, como 33cm ou 19cm', 'string', '') }}\",\n  \"comprimento\": \"{{ $fromAI('comprimento', 'comprimento da pe√ßa, como 100cm ou 12m', 'string', '') }}\",\n  \"material\": \"{{ $fromAI('material', 'material principal do item (ex: concreto, cer√¢mica, cimento)', 'string', '') }}\",\n  \"codigo\": \"{{ $fromAI('codigo', 'c√≥digo interno do item, como H8/33', 'string', '') }}\",\n  \"referencia\": \"{{ $fromAI('referencia', 'refer√™ncia interna ou apelido do produto', 'string', '') }}\",\n  \"descricao\": \"{{ $fromAI('descricao', 'descri√ß√£o complementar fornecida pelo cliente', 'string', '') }}\",\n  \"tipo\": \"{{ $fromAI('tipo', 'tipo especial do produto (ex: custom)', 'string', '') }}\",\n  \"categoria\": \"{{ $fromAI('categoria', 'categoria geral como laje, coluna, armacao, enchimento, veda√ß√£o', 'string', '') }}\",\n  \"tipo_uso\": \"{{ $fromAI('tipo_uso', 'uso principal do produto (ex: refor√ßo, enchimento, arma√ß√£o, veda√ß√£o)', 'string', '') }}\"\n}\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -1060,
        1140
      ],
      "id": "f068cedf-ffa4-45a9-94bb-42c0da2f46fb",
      "name": "busca_preco"
    },
    {
      "parameters": {
        "name": "ultimos_orcamentos",
        "description": " Lista os √∫ltimos or√ßamentos realizados pelo lead.",
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $workflow.id }}"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "cons_orc",
            "tableName": "orcamentos",
            "leadid": "1"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "id": "3a1792bb-1e7d-46e9-af01-3bb3ae85055d",
      "name": "ultimos_orcamentos",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "position": [
        -960,
        1160
      ],
      "typeVersion": 2.1
    },
    {
      "parameters": {
        "name": "salvar_orcamento",
        "description": "=Salva um or√ßamento para um cliente com a lista de produtos cotados, pre√ßos, total e v√≠nculo com o lead correspondente.\nPara cada produto:\n- Identifique o nome exato (conforme a tabela de produtos).\n- Use o tool 'busca_produto' para consultar o pre√ßo na tabela 'produtos_precos'.\n- Calcule o subtotal: preco_unitario √ó quantidade.\n",
        "workflowId": {
          "__rl": true,
          "value": "={{ $workflow.id }}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "salvar_orcamento",
            "tableName": "orcamentos",
            "leadid": "1",
            "Produtos": "={{ JSON.stringify($fromAI('produtos', `Gere a lista de produtos que o cliente deseja or√ßar. Para cada produto:\n- Identifique o nome exato (conforme a tabela de produtos).\n- Use o tool 'busca_produto' para consultar o pre√ßo na tabela 'produtos_precos'.\n- Calcule o subtotal: preco_unitario √ó quantidade.\n- Retorne os campos:\n\n[\n  {\n    \\\"nome\\\": \\\"Ferragem F10\\\",\n    \\\"quantidade\\\": 12,\n    \\\"unidade\\\": \\\"metro\\\",\n    \\\"detalhes\\\": {\n      \\\"bitola_estribo\\\": \\\"4.2mm\\\",\n      \\\"tamanho_estribo\\\": \\\"7x17\\\",\n    \\\"preco_unitario\\\": 25.00,\n    \\\"subtotal\\\": 300.00\n    }\n  },\n  ...\n]\n\nSe n√£o souber alguma especifica√ß√£o, deixe o campo 'detalhes' vazio ou omita.\nNunca estime valores manualmente. Sempre consulte o pre√ßo com 'busca_produto'.`, 'json')) }}",
            "Obs": "={{ $fromAI('observacoes', `Observa√ß√µes gerais sobre o or√ßamento solicitado. Inclua instru√ß√µes extras dadas pelo cliente, coment√°rios adicionais, condi√ß√µes especiais (como forma de pagamento ou prazo), ou qualquer informa√ß√£o que ajude o setor comercial ou log√≠stica. Se o cliente n√£o disser nada relevante, retorne string vazia.`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "id": "a57cb16e-0e90-4b05-99fe-e22c43f9252b",
      "name": "salvar_orcamento",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "position": [
        -720,
        1160
      ],
      "typeVersion": 2.1
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        -620,
        1140
      ],
      "id": "74346f85-6ac9-46cd-b420-846af45b8c28",
      "name": "Calculator"
    },
    {
      "parameters": {
        "description": "Calcula a quantidade estimada de materiais para montagem de uma laje, com base nas dimens√µes informadas\n  (largura e comprimento, ou apenas √°rea) e no tipo de enchimento escolhido (isopor ou lajota cer√¢mica).\n  Retorna a quantidade aproximada de vigotas, pe√ßas de enchimento (isopor ou lajota) e malhas de a√ßo necess√°rias.\n  Sempre que houver largura e comprimento, o c√°lculo ser√° feito com base no espa√ßamento real entre as vigotas.",
        "workflowId": {
          "__rl": true,
          "value": "={{ $workflow.id}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "calcLaje",
            "especificacoes": "={\n\"largura\": \"{{ $fromAI('largura', 'largura da laje em metros. Ex: 5', 'string') }}\",\n\"comprimento\": \"{{ $fromAI('comprimento', 'comprimento da laje em metros. Ex: 8', 'string') }}\",\n\"area\": \"{{ $fromAI('area', '√°rea total da laje em metros quadrados. Ex: 40. Use apenas se n√£o houver largura e comprimento.', 'string') }}\",\n\"enchimento\": \"{{ $fromAI('enchimento', 'tipo de enchimento da laje: \\\"isopor\\\" ou \\\"lajota\\\". Se o cliente n√£o disser, use \\\"isopor\\\" como padr√£o.', 'string', { default: 'isopor' }) }}\",\n\"malha\": \"{{ $fromAI('malha'), 'qual √© o modelo de malha ex:\"Leve 20x20 F3.4\", \"Media 15x15 F3.4\" ou \"Refor√ßada 15x15 F4.2\"', 'string', { default: 'Media' } }}\"\n}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -520,
        1160
      ],
      "id": "24d43731-d2db-4586-84e2-062ab4c5f286",
      "name": "calcular_laje"
    },
    {
      "parameters": {
        "description": "=Calcula o custo e o pre√ßo estimado de uma ferragem sob medida com base em comprimento, \n  ferros longitudinais (bitola e quantidade), tamanho e bitola dos estribos, espa√ßamento entre estribos,\n  custos de material e m√£o de obra. Caso a bitola dos estribos n√£o seja informada, usa-se \"F4.2\" como padr√£o, e se o espa√ßo entre os estribos n√£o for informada, usa-se \"0.20\", se o a quantidade de ferros n√£o for informada considere como padr√£o 4",
        "workflowId": {
          "__rl": true,
          "value": "={{$workflow.id}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "CalcFer",
            "ferragem": "={\n  \"comprimento\": {{ $fromAI(\"comprimento\", \"Comprimento total da ferragem em metros. Ex: para 'Ferragem 5,00', o valor √© 5.\", \"number\") }},\n  \"ferros_longitudinais\": {{ $fromAI(\"ferros_longitudinais\", \"Lista de ferros longitudinais utilizados na ferragem. Cada item deve conter: - bitola (ex: 'F10', 'F12', 'F8', etc) - quantidade de var√µes dessa bitola. Formato: [ { \\\"bitola\\\": \\\"F10\\\", \\\"quantidade\\\": 4 }, { \\\"bitola\\\": \\\"F12\\\", \\\"quantidade\\\": 2 } ] Extraia mesmo que o cliente envie como '4F10+2F12', converta para este array e envie como string JSON.\", \"string\") }},\n  \"tamanho_estribo\": \"{{ $fromAI(\"tamanho_estribo\", \"Tamanho do estribo no formato 'largura x altura' em cm. Ex: '7x20'.\", \"string\") }}\",\n  \"espacamento_estribo\": \"{{ $fromAI(\"espacamento_estribo\", \"Espa√ßamento entre estribos em metros. Ex: para 'a cd 0,15', o valor √© 0.15. Se n√£o for informado, use o padr√£o '0.20'.\", \"number\") }}\",\n  \"bitola_estribo\": \"{{ $fromAI(\"bitola_estribo\", \"Bitola do ferro do estribo (ex: 'F5'). Se n√£o for informado, use o padr√£o 'F4.2'.\", \"string\") }}\"\n}\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -400,
        1140
      ],
      "id": "83fa5f70-155e-41b6-a939-c954cd81af9e",
      "name": "calcular_ferragem_personalizada"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1380,
        1080
      ],
      "id": "a2e63d3a-1ce3-4156-b72f-9e411217e85a",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "operation"
            },
            {
              "name": "tableName"
            },
            {
              "name": "especificacoes",
              "type": "object"
            },
            {
              "name": "ferragem",
              "type": "object"
            },
            {
              "name": "detalhes",
              "type": "object"
            },
            {
              "name": "NomeProduto"
            },
            {
              "name": "leadid"
            },
            {
              "name": "Produtos"
            },
            {
              "name": "Obs"
            },
            {
              "name": "Status"
            }
          ]
        }
      },
      "id": "96343505-9c42-4324-a5f5-e0e6cba21df1",
      "name": "When Executed by Another Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -1240,
        300
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cf7a0fc-4415-4741-b2a4-701a39148d3b",
              "name": "operation",
              "value": "={{ $('When Executed by Another Workflow').item.json.operation }}",
              "type": "string"
            },
            {
              "id": "27fed7e0-f5c9-41db-b966-38830a4ddcec",
              "name": "tableName",
              "value": "={{ $('When Executed by Another Workflow').item.json.tableName }}",
              "type": "string"
            },
            {
              "id": "c6e0ba01-972b-4d5d-b7d1-e91f62488815",
              "name": "ferragem",
              "value": "={{ $('When Executed by Another Workflow').item.json.ferragem }}",
              "type": "object"
            },
            {
              "id": "9d46a701-ba02-4dd8-93dd-05ddf8eeb1df",
              "name": "detalhes",
              "value": "={{ $('When Executed by Another Workflow').item.json.detalhes }}",
              "type": "object"
            },
            {
              "id": "80e381a1-538f-4002-bf01-4d37f364c5f4",
              "name": "NomeProduto",
              "value": "={{ $('When Executed by Another Workflow').item.json.NomeProduto }}",
              "type": "string"
            },
            {
              "id": "ba30306c-acde-4724-9ec8-f1fc6b4ca2cb",
              "name": "leadid",
              "value": "={{ $('When Executed by Another Workflow').item.json[\"leadid\"] }}",
              "type": "string"
            },
            {
              "id": "b957c201-37a1-4ed4-8cf8-412b42687a2b",
              "name": "Produtos",
              "value": "={{ $('When Executed by Another Workflow').item.json.Produtos }}",
              "type": "array"
            },
            {
              "id": "47db7538-b69d-4aca-af4c-7507ffca4a8c",
              "name": "Obs",
              "value": "={{ $('When Executed by Another Workflow').item.json.Obs }}",
              "type": "string"
            },
            {
              "id": "3f52b47d-94c1-46f6-9316-b812208b0783",
              "name": "especificacoes",
              "value": "={{ $('When Executed by Another Workflow').item.json.especificacoes }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -880,
        300
      ],
      "id": "5a0c2547-d1e8-42f0-9f26-da61e9feba6f",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "preco_produto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "85fddca5-06c1-4f4c-8925-263a9e1a4019"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Pre√ßo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ca56cc1e-ff80-4e07-b0b0-22231edfc6f0",
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "cons_orc",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ultimos Orc"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e40f17ff-382c-4fa9-b9c6-46a09a0e28d2",
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "salvar_orcamento",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Salvar ORC"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fa934f1b-b194-499c-bf35-cdd8b0205aa6",
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "calcLaje",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CalcLaje"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45350893-485a-4280-86b4-e3a3a79f68e0",
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "CalcFer",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CalcFer"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -680,
        300
      ],
      "id": "9501a759-273e-4836-91e4-fb6afad65e04",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_agg(row_to_json(t))\nFROM {{ $json.tableName }} t;",
        "options": {}
      },
      "id": "57199341-9ad0-49df-9ee9-01a9bc98318b",
      "name": "ReadPreco",
      "type": "n8n-nodes-base.postgres",
      "position": [
        0,
        0
      ],
      "typeVersion": 2.6,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM {{ $json.tableName }}\nWHERE lead_id={{ $json.leadid }}\nLIMIT 5;",
        "options": {}
      },
      "id": "d1cbc423-44f2-4a3f-b043-6fa5388ab07c",
      "name": "ReadOrc",
      "type": "n8n-nodes-base.postgres",
      "position": [
        0,
        160
      ],
      "typeVersion": 2.6,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// --- Defini√ß√£o da Fun√ß√£o de Transforma√ß√£o ---\n// Esta fun√ß√£o recebe um array de objetos (onde cada objeto √© um item de dado, como o seu input JSON)\n// e transforma a string 'Produtos' em um objeto JS.\nfunction transformarProdutosEmObjeto(inputJsonArray) {\n  // Garantir que a entrada seja um array. Embora 'items' geralmente seja um array,\n  // esta checagem aumenta a robustez.\n  if (!Array.isArray(inputJsonArray)) {\n    console.warn(\"Input para transformarProdutosEmObjeto n√£o √© um array. Tentando processar como um √∫nico item.\");\n    inputJsonArray = [inputJsonArray]; // Converte para um array de um item\n  }\n\n  // Percorre cada item no array de entrada\n  return inputJsonArray.map(item => {\n    // Cria uma c√≥pia rasa do objeto para evitar modificar o objeto original diretamente.\n    // Isso √© importante para a seguran√ßa dos dados e para evitar efeitos colaterais.\n    const newItem = { ...item };\n\n    // Verifica se a propriedade 'Produtos' existe e √© uma string\n    if (typeof newItem.Produtos === 'string') {\n      try {\n        // Tenta converter a string JSON em um objeto JavaScript.\n        newItem.Produtos = JSON.parse(newItem.Produtos);\n      } catch (e) {\n        // Se a string 'Produtos' n√£o for um JSON v√°lido, um erro ser√° capturado aqui.\n        // √â importante logar o erro para depura√ß√£o.\n        console.error(`Erro ao fazer parse da string 'Produtos' no item (ID ou opera√ß√£o: ${newItem.leadid || newItem.operation}):`, e);\n        \n        // Decis√£o sobre como lidar com JSON inv√°lido:\n        // 1. Manter a string original (se quiser ignorar o erro de parse e ter o dado bruto):\n        //    newItem.Produtos = newItem.Produtos; \n        // 2. Definir como null (para indicar que o parse falhou e o dado n√£o √© um objeto):\n           newItem.Produtos = null; \n        // 3. Remover a propriedade (se n√£o quiser que ela apare√ßa na sa√≠da se for inv√°lida):\n        //    delete newItem.Produtos;\n      }\n    }\n    return newItem; // Retorna o item (modificado ou n√£o) para o novo array\n  });\n}\n\n// --- Parte Principal do Script para o N√≥ 'Code' ---\n\n// Em ambientes como o n8n, a entrada de dados para um n√≥ 'Code'\n// quando configurado para \"Run Once For All Items\" (como parece ser o seu caso pela imagem)\n// geralmente √© um array de objetos, onde cada objeto tem uma propriedade 'json'\n// que cont√©m os dados reais do item.\n// Exemplo: [ { json: { ...item1Data... } }, { json: { ...item2Data... } } ]\n\nlet inputDataForFunction = [];\n\n// Acessar a vari√°vel de entrada fornecida pelo ambiente (mais comumente 'items')\nif (typeof items !== 'undefined' && Array.isArray(items)) {\n    // Mapeia o array 'items' para extrair apenas a parte 'json' de cada item,\n    // que √© o seu dado real de entrada.\n    inputDataForFunction = items.map(item => item.json);\n} else {\n    // Caso 'items' n√£o seja a vari√°vel esperada ou n√£o seja um array.\n    // Isto √© um fallback para depura√ß√£o, indicando que a entrada n√£o foi encontrada.\n    console.error(\"Erro: A vari√°vel de entrada 'items' n√£o foi encontrada ou n√£o √© um array v√°lido. Verifique a configura√ß√£o da entrada do n√≥.\");\n    // Retorna um array vazio para evitar erros, mas isso indica um problema na entrada.\n    return []; \n}\n\n// Chama a fun√ß√£o de transforma√ß√£o com os dados de entrada extra√≠dos.\nconst transformedOutput = transformarProdutosEmObjeto(inputDataForFunction);\n\n// --- Retornar o Resultado ---\n// O n√≥ 'Code' espera que o script retorne um array de objetos.\n// Cada objeto neste array retornado se tornar√° um 'item' na sa√≠da do n√≥.\nreturn transformedOutput;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        300
      ],
      "id": "119fbda8-3080-4b39-a264-f82fc38cb6ff",
      "name": "Code",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// --- Defini√ß√£o da Fun√ß√£o de Transforma√ß√£o (mantida igual) ---\n// Esta fun√ß√£o processa o array de itens, fazendo o parse da string 'Produtos' em cada um.\nfunction transformarProdutosEmObjeto(inputJsonArray) {\n  // Garante que a entrada seja um array (mesmo que venha apenas um item solto)\n  if (!Array.isArray(inputJsonArray)) {\n    console.warn(\"Input para transformarProdutosEmObjeto n√£o √© um array. Tentando processar como um √∫nico item.\");\n    inputJsonArray = [inputJsonArray];\n  }\n\n  // Mapeia cada item do array de entrada\n  return inputJsonArray.map(item => {\n    const newItem = { ...item }; // Cria uma c√≥pia rasa do item\n\n    // Processa a propriedade 'Produtos' se for uma string\n    if (typeof newItem.Produtos === 'string') {\n      try {\n        newItem.Produtos = JSON.parse(newItem.Produtos); // Converte a string para um array/objeto JS\n      } catch (e) {\n        console.error(`Erro ao fazer parse da string 'Produtos' para o item (ID ou opera√ß√£o: ${newItem.leadid || newItem.operation}):`, e);\n        newItem.Produtos = null; // Em caso de erro, define como null\n      }\n    }\n    return newItem;\n  });\n}\n\n// --- Parte Principal do Script para o N√≥ 'Code' ---\n\nlet inputDataForFunction = [];\n\n// Obt√©m os dados de entrada do n√≥, assumindo o formato do n8n (items.map(item => item.json))\nif (typeof items !== 'undefined' && Array.isArray(items)) {\n    inputDataForFunction = items.map(item => item.json);\n} else {\n    console.error(\"Erro: A vari√°vel 'items' n√£o foi encontrada ou n√£o √© um array v√°lido. Verifique a configura√ß√£o da entrada do n√≥.\");\n    return []; \n}\n\n// 1. Chama a fun√ß√£o de transforma√ß√£o inicial para garantir que 'Produtos' √© um array JS\nconst transformedItems = transformarProdutosEmObjeto(inputDataForFunction);\n\n// 2. Agora, itera sobre os itens transformados para calcular o total\nconst finalOutput = transformedItems.map(item => {\n    let totalSoma = 0;\n\n    // Verifica se 'Produtos' existe e √© um array ap√≥s a transforma√ß√£o\n    if (Array.isArray(item.Produtos)) {\n        item.Produtos.forEach(produto => {\n            // Acessa o subtotal dentro do objeto 'detalhes' de cada produto\n            if (produto.detalhes && typeof produto.detalhes.subtotal === 'number') {\n                totalSoma += produto.detalhes.subtotal;\n            } else if (produto.detalhes && produto.detalhes.subtotal === null) {\n                console.warn(`Subtotal nulo encontrado para o produto: ${produto.nome || 'desconhecido'}. Tratando como 0 na soma.`);\n            } else {\n                console.warn(`Produto sem 'detalhes.subtotal' num√©rico ou nulo para o produto: ${produto.nome || 'desconhecido'}.`);\n            }\n        });\n    } else if (item.Produtos !== null) { // Se n√£o √© array nem null (ex: undefined, ou string inv√°lida)\n        console.warn(`Propriedade 'Produtos' n√£o √© um array v√°lido para o item (opera√ß√£o: ${item.operation || 'desconhecida'}), n√£o √© poss√≠vel calcular o total.`);\n    }\n    \n    // Adiciona o total calculado a uma nova propriedade no item.\n    // Usamos 'totalCalculado' para evitar conflito com um 'total' que possa vir na entrada original.\n    return {\n        ...item, // Mant√©m todas as outras propriedades do item\n        totalCalculado: totalSoma // Adiciona a nova propriedade com a soma\n    };\n});\n\n// 3. Retorna o resultado final do n√≥ JavaScript\nreturn finalOutput;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -260,
        340
      ],
      "id": "60d49f0e-6aa8-4be3-bc1f-bb8c08131a79",
      "name": "CalcTotal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{$json.tableName}} (lead_id, produtos, total, obs)\nVALUES (\n    {{ $json.leadid }},\n    '{{ JSON.stringify($json.Produtos) }}'::jsonb,\n    {{ $json.totalCalculado }},\n    {{ $json.Obs ? \"'\" + $json.Obs + \"'\" : 'NULL' }}\n  );",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        340
      ],
      "id": "917c5ba7-3576-4dc9-b739-bd21f8f93cf3",
      "name": "InsertOrc"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "38442fcb-45fb-4aad-ad1f-e36fe0b16216",
              "leftValue": "={{ parseFloat($json.especificacoes.largura) <= 7 || parseFloat($json.especificacoes.comprimento) <= 7 }}",
              "rightValue": "=",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -40,
        520
      ],
      "id": "66b8f32a-b415-43cf-bd64-774cf9bc5bdf",
      "name": "IfModoCalc"
    },
    {
      "parameters": {
        "jsCode": "// Entradas esperadas: 'comprimento' e 'largura' dentro de 'especificacoes'\nconst especificacoes = $input.first().json.especificacoes || {};\nconst comprimento = parseFloat(especificacoes.comprimento || 0);\nconst largura = parseFloat(especificacoes.largura || 0);\n\n// Pre√ßos dos produtos vindos do input 'todos_os_produtos'\n// Certifique-se de que 'todos_os_produtos' esteja sempre presente e no formato esperado\nconst produtosPrecos = $input.first().json.todos_os_produtos || {};\n\n// Fun√ß√£o auxiliar para buscar o pre√ßo base de um produto pelo nome\n// Busca a chave mais pr√≥xima no objeto produtosPrecos (case-insensitive e cont√©m)\nfunction getPreco(nomeProdutoBuscado) {\n    const nomeNormalizado = nomeProdutoBuscado.toLowerCase();\n    for (const key in produtosPrecos) {\n        if (key.toLowerCase().includes(nomeNormalizado)) {\n            return parseFloat(produtosPrecos[key]);\n        }\n    }\n    return 0; // Retorna 0 se o pre√ßo n√£o for encontrado\n}\n\n// Calcula a √°rea a partir das dimens√µes fornecidas\nconst area = comprimento * largura;\n\nconst enchimento = (especificacoes.enchimento || 'isopor').toLowerCase();\nconst tipoMalha = (especificacoes.malha || 'malha leve').toLowerCase(); // Captura o tipo de malha especificado\n\nlet vigotas_por_metro_linear; // Quantidade de vigotas por metro linear da dimens√£o maior\nif (enchimento === 'isopor') {\n    vigotas_por_metro_linear = 2.5;\n} else if (enchimento === 'lajota') {\n    vigotas_por_metro_linear = 3.0;\n} else {\n    vigotas_por_metro_linear = 2.5; // padr√£o\n}\n\n// --- L√≥gica para c√°lculo de vigotas (quantidade e tamanho) ---\nconst dim_menor = Math.min(comprimento, largura);\nconst dim_maior = Math.max(comprimento, largura);\n\nconst tamanho_vigota = dim_menor; // O menor lado serve como tamanho de cada vigota\nconst qtd_vigotas = Math.ceil(dim_maior * vigotas_por_metro_linear); // O maior lado define a quantidade de vigotas\n\n// Estimativas de consumo por m¬≤ (iguais ao outro JS, dependem da √°rea)\nconst qtd_isopor = Math.ceil(area / 0.4166666666);   // ~2.4 pe√ßas por m¬≤\n\n// --- L√≥gica da Lajota (arredondamento complexo, depende da √°rea) ---\nconst qtd_lajota_base = Math.ceil(area / 0.0666666666); // ~15 lajotas por m¬≤\n\nconst unidade_arredondamento = 5;\nconst tolerancia_percentual = 0.03; // 3%\n\nconst limite_inferior = qtd_lajota_base * (1 - tolerancia_percentual);\nconst limite_superior = qtd_lajota_base * (1 + tolerancia_percentual);\n\nlet qtd_lajota_final = qtd_lajota_base; // Inicia com o valor base (fallback)\n\nconst candidato_para_baixo = Math.floor(qtd_lajota_base / unidade_arredondamento) * unidade_arredondamento;\nconst candidato_para_cima = Math.ceil(qtd_lajota_base / unidade_arredondamento) * unidade_arredondamento;\n\nlet candidatos_validos = [];\n\nif (candidato_para_baixo >= limite_inferior && candidato_para_baixo <= limite_superior) {\n    candidatos_validos.push(candidato_para_baixo);\n}\n\nif (candidato_para_cima !== candidato_para_baixo && candidato_para_cima >= limite_inferior && candidato_para_cima <= limite_superior) {\n    candidatos_validos.push(candidato_para_cima);\n}\n\nif (candidatos_validos.length > 0) {\n    let melhor_candidato = candidatos_validos[0];\n    let menor_diferenca = Math.abs(qtd_lajota_base - melhor_candidato);\n\n    for (let i = 1; i < candidatos_validos.length; i++) {\n        const candidato_atual = candidatos_validos[i];\n        const diferenca_atual = Math.abs(qtd_lajota_base - candidato_atual);\n        if (diferenca_atual < menor_diferenca) {\n            menor_diferenca = diferenca_atual;\n            melhor_candidato = candidato_atual;\n        }\n    }\n    qtd_lajota_final = melhor_candidato;\n}\nconst qtd_lajota = qtd_lajota_final;\n// --- FIM DA L√ìGICA DA LAJOTA ---\n\nconst qtd_malha = Math.ceil(area / 5.8);\n\n\n// --- C√ÅLCULO DOS PRE√áOS ---\nconst preco_trelica = getPreco('Trelica');\n\nlet preco_isopor = 0;\nif (enchimento === 'isopor') {\n    if (produtosPrecos['Isopor H7/33']) {\n        preco_isopor = getPreco('Isopor H7/33');\n    } else if (produtosPrecos['Isopor H8/33']) {\n        preco_isopor = getPreco('Isopor H8/33');\n    } else if (produtosPrecos['Isopor H8/40']) {\n        preco_isopor = getPreco('Isopor H8/40');\n    }\n}\n\nconst preco_lajota = getPreco('Lajota Cer√¢mica');\nlet preco_malha = 0;\n// L√≥gica para obter o pre√ßo da malha com base no tipoMalha\nif (tipoMalha.includes('leve')) {\n    preco_malha = getPreco('Malha Leve 20x20 F3.4');\n} else if (tipoMalha.includes('media')) {\n    preco_malha = getPreco('Malha Media 15x15 F3.4');\n} else if (tipoMalha.includes('reforcada')) {\n    preco_malha = getPreco('Malha Refor√ßada 15x15 F4.2');\n} else {\n    preco_malha = getPreco('Malha Leve 20x20 F3.4'); // Padr√£o\n}\n\n\n// Calcular os totais (garantindo que n√£o seja NaN e arredondando)\nconst valor_trelica = parseFloat((qtd_vigotas * tamanho_vigota * preco_trelica).toFixed(2));\nconst valor_isopor = enchimento === 'isopor' ? parseFloat((qtd_isopor * preco_isopor).toFixed(2)) : 0;\nconst valor_lajota = enchimento === 'lajota' ? parseFloat((qtd_lajota * preco_lajota).toFixed(2)) : 0;\nconst valor_malha = parseFloat((qtd_malha * preco_malha).toFixed(2));\n\n// Calcular o valor total geral\nconst valor_total_geral = parseFloat((valor_trelica + valor_isopor + valor_lajota + valor_malha).toFixed(2));\n\n\nreturn [\n    {\n        json: {\n            area: parseFloat(area.toFixed(2)),\n            enchimento,\n            // Detalhes da Treli√ßa\n            trelica: {\n                quantidade_vigotas: qtd_vigotas,\n                tamanho_vigota: parseFloat(tamanho_vigota.toFixed(2)),\n                // Pre√ßo por metro linear da treli√ßa\n                preco_por_metro: preco_trelica,\n                valor_total: valor_trelica\n            },\n            // Detalhes do Isopor\n            isopor: enchimento === 'isopor' ? {\n                quantidade: qtd_isopor,\n                preco_unitario: preco_isopor,\n                valor_total: valor_isopor\n            } : null,\n            // Detalhes da Lajota\n            lajota: enchimento === 'lajota' ? {\n                quantidade: qtd_lajota,\n                preco_unitario: preco_lajota,\n                valor_total: valor_lajota\n            } : null,\n            // Detalhes da Malha\n            malha: {\n                tipo_selecionado: tipoMalha, // Adicionado o tipo de malha selecionado\n                quantidade: qtd_malha,\n                preco_unitario: preco_malha,\n                valor_total: valor_malha\n            },\n            valor_total_geral: valor_total_geral\n        }\n    }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        180,
        440
      ],
      "id": "e73f218e-5937-446d-888e-ee60871491d5",
      "name": "CalcLajeC*L"
    },
    {
      "parameters": {
        "jsCode": "// Entradas das especifica√ß√µes\nconst especificacoes = $input.first().json.especificacoes || {};\nconst inputLargura = parseFloat(especificacoes.largura);\nconst inputComprimento = parseFloat(especificacoes.comprimento);\nconst inputArea = parseFloat(especificacoes.area); // 'area' pode vir diretamente\n\nlet area;\nlet comprimento_maior_dimensao = 0; // Usado para c√°lculo de metragem da treli√ßa se L/C forem dados\n\n// L√≥gica para determinar a √°rea e as dimens√µes finais\nif (!isNaN(inputLargura) && !isNaN(inputComprimento) && inputLargura > 0 && inputComprimento > 0) {\n    // Se largura e comprimento v√°lidos forem fornecidos, calcula a √°rea e a maior dimens√£o\n    area = inputComprimento * inputLargura;\n    comprimento_maior_dimensao = Math.max(inputComprimento, inputLargura);\n} else if (!isNaN(inputArea) && inputArea > 0) {\n    // Se a √°rea for fornecida diretamente\n    area = inputArea;\n    // Se a √°rea for a √∫nica entrada, a maior dimens√£o para c√°lculo de treli√ßa\n    // ser√° a raiz quadrada da √°rea (assumindo uma forma quadrada para estimativa),\n    // ou simplesmente usaremos 'area' para o c√°lculo direto da metragem de treli√ßa.\n    // Para simplificar, vou considerar que quando s√≥ a √°rea √© dada, a qtd_vigotas\n    // j√° representa os metros totais com base em uma densidade por m¬≤.\n    comprimento_maior_dimensao = Math.sqrt(area); // Estima uma dimens√£o para usar no c√°lculo linear de treli√ßa, se necess√°rio.\n                                                 // No entanto, para treli√ßas por \"metro\", a √°rea √© mais direta.\n} else {\n    // Nenhum dado v√°lido para c√°lculo de √°rea\n    throw new Error('As especifica√ß√µes devem conter \"area\" OU \"largura\" e \"comprimento\" v√°lidos.');\n}\n\nconst enchimento = (especificacoes.enchimento || 'isopor').toLowerCase();\nconst tipoMalha = (especificacoes.malha || 'malha leve').toLowerCase(); // Captura o tipo de malha especificado\n\n// Pre√ßos dos produtos vindos do input 'todos_os_produtos'\nconst produtosPrecos = $input.first().json.todos_os_produtos || {};\n\n// Fun√ß√£o auxiliar para buscar o pre√ßo base de um produto pelo nome\nfunction getPreco(nomeProdutoBuscado) {\n    const nomeNormalizado = nomeProdutoBuscado.toLowerCase();\n    for (const key in produtosPrecos) {\n        if (key.toLowerCase().includes(nomeNormalizado)) {\n            return parseFloat(produtosPrecos[key]);\n        }\n    }\n    return 0;\n}\n\nlet trelica_por_metro_linear; // Renomeado para maior clareza\nif (enchimento === 'isopor') {\n    trelica_por_metro_linear = 2.5; // Metros de treli√ßa por metro linear de laje\n} else if (enchimento === 'lajota') {\n    trelica_por_metro_linear = 3.0; // Metros de treli√ßa por metro linear de laje\n} else {\n    trelica_por_metro_linear = 2.5; // Padr√£o\n}\n\n// O c√°lculo da metragem total de treli√ßa agora √© mais direto:\n// Se dimens√µes foram dadas, usamos a maior dimens√£o da laje * trelica_por_metro_linear (metragem).\n// Se apenas a √°rea foi dada, multiplicamos a √°rea por trelica_por_metro_linear (densidade por m¬≤).\n// A l√≥gica √© que trelica_por_metro_linear representa quantos metros de treli√ßa s√£o necess√°rios por metro da dimens√£o maior,\n// ou quantos metros s√£o necess√°rios por m¬≤ de √°rea total (dependendo de como voc√™ modelou isso para a laje).\n// Para o cen√°rio 's√≥ em metro', a interpreta√ß√£o mais comum seria metragem total baseada na √°rea.\nconst metragem_total_trelica = Math.ceil(area * trelica_por_metro_linear); // Metragem total de treli√ßa em metros\n\n\n// Estimativas de consumo por m¬≤:\nconst qtd_isopor = Math.ceil(area / 0.4166666666);\n\n// --- L√≥gica da Lajota (arredondamento complexo) ---\nconst qtd_lajota_base = Math.ceil(area / 0.0666666666);\nconst unidade_arredondamento = 5;\nconst tolerancia_percentual = 0.03;\nconst limite_inferior = qtd_lajota_base * (1 - tolerancia_percentual);\nconst limite_superior = qtd_lajota_base * (1 + tolerancia_percentual);\nlet qtd_lajota_final = qtd_lajota_base;\nconst candidato_para_baixo = Math.floor(qtd_lajota_base / unidade_arredondamento) * unidade_arredondamento;\nconst candidato_para_cima = Math.ceil(qtd_lajota_base / unidade_arredondamento) * unidade_arredondamento;\nlet candidatos_validos = [];\n\nif (candidato_para_baixo >= limite_inferior && candidato_para_baixo <= limite_superior) {\n    candidatos_validos.push(candidato_para_baixo);\n}\nif (candidato_para_cima !== candidato_para_baixo && candidato_para_cima >= limite_inferior && candidato_para_cima <= limite_superior) {\n    candidatos_validos.push(candidato_para_cima);\n}\n\nif (candidatos_validos.length > 0) {\n    let melhor_candidato = candidatos_validos[0];\n    let menor_diferenca = Math.abs(qtd_lajota_base - melhor_candidato);\n    for (let i = 1; i < candidatos_validos.length; i++) {\n        const candidato_atual = candidatos_validos[i];\n        const diferenca_atual = Math.abs(qtd_lajota_base - candidato_atual);\n        if (diferenca_atual < menor_diferenca) {\n            menor_diferenca = diferenca_atual;\n            melhor_candidato = candidato_atual;\n        }\n    }\n    qtd_lajota_final = melhor_candidato;\n}\nconst qtd_lajota = qtd_lajota_final;\n// --- FIM DA L√ìGICA DA LAJOTA ---\n\nconst qtd_malha = Math.ceil(area / 5.8);\n\n\n// --- C√ÅLCULO DOS PRE√áOS ---\nconst preco_trelica = getPreco('Trelica'); // Pre√ßo por metro\n\nlet preco_isopor = 0;\nif (enchimento === 'isopor') {\n    if (produtosPrecos['Isopor H7/33']) {\n        preco_isopor = getPreco('Isopor H7/33');\n    } else if (produtosPrecos['Isopor H8/33']) {\n        preco_isopor = getPreco('Isopor H8/33');\n    } else if (produtosPrecos['Isopor H8/40']) {\n        preco_isopor = getPreco('Isopor H8/40');\n    }\n}\n\nconst preco_lajota = getPreco('Lajota Cer√¢mica');\nlet preco_malha = 0;\nif (tipoMalha.includes('leve')) {\n    preco_malha = getPreco('Malha Leve 20x20 F3.4');\n} else if (tipoMalha.includes('media')) {\n    preco_malha = getPreco('Malha Media 15x15 F3.4');\n} else if (tipoMalha.includes('reforcada')) {\n    preco_malha = getPreco('Malha Refor√ßada 15x15 F4.2');\n} else {\n    preco_malha = getPreco('Malha Leve 20x20 F3.4'); // Padr√£o\n}\n\n\n// Calcular os totais (garantindo que n√£o seja NaN e arredondando)\n// O valor da treli√ßa agora √© simplesmente metragem_total_trelica * preco_trelica\nconst valor_trelica = parseFloat((metragem_total_trelica * preco_trelica).toFixed(2));\nconst valor_isopor = enchimento === 'isopor' ? parseFloat((qtd_isopor * preco_isopor).toFixed(2)) : 0;\nconst valor_lajota = enchimento === 'lajota' ? parseFloat((qtd_lajota * preco_lajota).toFixed(2)) : 0;\nconst valor_malha = parseFloat((qtd_malha * preco_malha).toFixed(2));\n\n// Calcular o valor total geral\nconst valor_total_geral = parseFloat((valor_trelica + valor_isopor + valor_lajota + valor_malha).toFixed(2));\n\n\nreturn [\n    {\n        json: {\n            area: parseFloat(area.toFixed(2)),\n            enchimento,\n            // Detalhes da Treli√ßa (apenas metragem e pre√ßo por metro)\n            trelica: {\n                metragem_total: metragem_total_trelica, // Renomeado de quantidade_vigotas para metragem_total\n                preco_por_metro: preco_trelica,\n                valor_total: valor_trelica\n            },\n            // Detalhes do Isopor\n            isopor: enchimento === 'isopor' ? {\n                quantidade: qtd_isopor,\n                preco_unitario: preco_isopor,\n                valor_total: valor_isopor\n            } : null,\n            // Detalhes da Lajota\n            lajota: enchimento === 'lajota' ? {\n                quantidade: qtd_lajota,\n                preco_unitario: preco_lajota,\n                valor_total: valor_lajota\n            } : null,\n            // Detalhes da Malha\n            malha: {\n                tipo_selecionado: tipoMalha,\n                quantidade: qtd_malha,\n                preco_unitario: preco_malha,\n                valor_total: valor_malha\n            },\n            valor_total_geral: valor_total_geral\n        }\n    }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        180,
        600
      ],
      "id": "3d6e6531-9dfb-4eb5-ba25-724d1bd95b39",
      "name": "CalcLajeA"
    },
    {
      "parameters": {
        "jsCode": "const precos_ferros = {\n  \"F12.5\": 71.50,\n  \"F10\": 47.50,\n  \"F8\": 32.50,\n  \"F6.3\": 21.00,\n  \"F5\": 14.35,\n  \"F4.2\": 9.35,\n};\n\nconst preco_mao_obra_por_ponto = 0.09;\nconst margem = 0.61;\n\n// Entrada\nconst comprimento = parseFloat($json.ferragem.comprimento);\nconst espacamento = parseFloat($json.ferragem.espacamento_estribo);\nconst tamanho_estribo = $json.ferragem.tamanho_estribo; // ex: \"7x20\"\nconst bitola_estribo = $json.ferragem.bitola_estribo || \"F4.2\";\n\nconst ferros_input = $json.ferragem.ferros_longitudinais;\n\n// Fun√ß√£o para converter string tipo \"3F10+2F8\" em array de objetos\nfunction parseFerros(str) {\n  return str.split(\"+\").map(item => {\n    const match = item.trim().match(/(\\d+)\\s*F([\\d.]+)/i);\n    if (!match) throw new Error(`Formato inv√°lido: ${item}`);\n    return {\n      bitola: `F${match[2]}`,\n      quantidade: parseInt(match[1])\n    };\n  });\n}\n\nconst ferros = Array.isArray(ferros_input) ? ferros_input : parseFerros(ferros_input);\n\n// Custo dos ferros longitudinais\nlet custo_ferros = 0;\nlet total_ferros = 0;\nfor (const ferro of ferros) {\n  const preco = precos_ferros[ferro.bitola];\n  if (!preco) throw new Error(`Bitola n√£o encontrada: ${ferro.bitola}`);\n  custo_ferros += (preco / 12) * ferro.quantidade * comprimento;\n  total_ferros += ferro.quantidade;\n}\n\n// M√£o de obra (quantidade de pontos solda)\nconst pontos = Math.ceil(comprimento / espacamento) * total_ferros;\nconst custo_mao_obra = pontos * preco_mao_obra_por_ponto;\n\n// Custo dos estribos\nconst [largura_cm, altura_cm] = tamanho_estribo.split(\"x\").map(v => parseFloat(v.trim()));\nconst perimetro_m = (2 * (largura_cm + altura_cm)) / 100 + 0.05; // mais 5cm folga\nconst preco_varao_estribo = precos_ferros[bitola_estribo] || 13.00;\nconst custo_estribos = (comprimento / espacamento) * (perimetro_m / 12) * preco_varao_estribo;\n\n// Total e pre√ßo final\nconst preco_custo_total = custo_ferros + custo_mao_obra + custo_estribos;\nconst preco_venda = parseFloat((preco_custo_total * (1 + margem)).toFixed(2));\n\n// Descri√ß√£o da ferragem\nconst descricao_ferragem = `Ferragem ${comprimento.toFixed(2)} C/${ferros.map(f => `${f.quantidade}F${f.bitola.replace(\"F\", \"\")}`).join(\"+\")} ${tamanho_estribo} a cd ${espacamento.toFixed(2)} ${bitola_estribo}`;\n\nreturn [\n  {\n    json: {\n      descricao_ferragem,\n      /*\n      custo_ferros: parseFloat(custo_ferros.toFixed(2)),\n      custo_estribos: parseFloat(custo_estribos.toFixed(2)),\n      custo_mao_obra: parseFloat(custo_mao_obra.toFixed(2)),\n      preco_custo_total: parseFloat(preco_custo_total.toFixed(2)),\n      */\n      preco_venda: preco_venda\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -220,
        780
      ],
      "id": "a07cb8b6-a247-4845-8f3d-09e9f749c273",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "for (const item of items) {\n  const outputString = item.json.output;\n  let jsonString = outputString.replace(/```json\\n|```/g, '').trim();\n\n  // Tenta parsear a string JSON\n  try {\n    item.json = JSON.parse(jsonString);\n  } catch (e) {\n    // Em caso de erro, voc√™ pode logar, retornar um erro, ou lidar de outra forma\n    console.error(\"Erro ao parsear JSON:\", e, \"String original:\", jsonString);\n    // Opcional: Se quiser que o workflow falhe neste item\n    // throw new Error(\"Falha ao parsear JSON\");\n  }\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -920,
        860
      ],
      "id": "5b951eae-dbb6-486a-bc63-d6cd105832f1",
      "name": "Code2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cf7a0fc-4415-4741-b2a4-701a39148d3b",
              "name": "operation",
              "value": "={{ $('When Executed by Another Workflow').item.json.operation }}",
              "type": "string"
            },
            {
              "id": "27fed7e0-f5c9-41db-b966-38830a4ddcec",
              "name": "tableName",
              "value": "={{ $('When Executed by Another Workflow').item.json.tableName }}",
              "type": "string"
            },
            {
              "id": "c6e0ba01-972b-4d5d-b7d1-e91f62488815",
              "name": "ferragem",
              "value": "={{ $('When Executed by Another Workflow').item.json.ferragem }}",
              "type": "object"
            },
            {
              "id": "9d46a701-ba02-4dd8-93dd-05ddf8eeb1df",
              "name": "detalhes",
              "value": "={{ $('When Executed by Another Workflow').item.json.detalhes }}",
              "type": "object"
            },
            {
              "id": "80e381a1-538f-4002-bf01-4d37f364c5f4",
              "name": "NomeProduto",
              "value": "={{ $('When Executed by Another Workflow').item.json.NomeProduto }}",
              "type": "string"
            },
            {
              "id": "ba30306c-acde-4724-9ec8-f1fc6b4ca2cb",
              "name": "leadid",
              "value": "={{ $('When Executed by Another Workflow').item.json[\"leadid\"] }}",
              "type": "string"
            },
            {
              "id": "b957c201-37a1-4ed4-8cf8-412b42687a2b",
              "name": "Produtos",
              "value": "={{ $('When Executed by Another Workflow').item.json.Produtos }}",
              "type": "array"
            },
            {
              "id": "47db7538-b69d-4aca-af4c-7507ffca4a8c",
              "name": "Obs",
              "value": "={{ $('When Executed by Another Workflow').item.json.Obs }}",
              "type": "string"
            },
            {
              "id": "3f52b47d-94c1-46f6-9316-b812208b0783",
              "name": "especificacoes",
              "value": "={{ $('When Executed by Another Workflow').item.json.especificacoes }}",
              "type": "object"
            },
            {
              "id": "a73f0334-7dc0-4771-b97b-2dcdfb835841",
              "name": "todos_os_produtos",
              "value": "={\n\"{{ $json.todos_os_produtos.isopor[0].nome }}\": {{ $json.todos_os_produtos.isopor[0].preco_base }},\n\"{{ $json.todos_os_produtos.malhas[0].nome }}\": {{ $json.todos_os_produtos.malhas[0].preco_base }},\n\"{{ $json.todos_os_produtos.malhas[1].nome }}\":{{ $json.todos_os_produtos.malhas[1].preco_base }},\n\"{{ $json.todos_os_produtos.malhas[2].nome }}\":{{ $json.todos_os_produtos.malhas[2].preco_base }},\n\"Trelica\":{{ $json.todos_os_produtos.trelicas[0].preco_base }}\n}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -220,
        520
      ],
      "id": "863166c7-e3c4-4ed4-8b86-02eccf935247",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n    jsonb_build_object(\n        'trelicas', (SELECT jsonb_agg(jsonb_build_object('nome', nome, 'preco_base', preco_base)) FROM produtos_precos WHERE nome ILIKE '%' || 'treli√ßa concretada' || '%'),\n        'malhas', (SELECT jsonb_agg(jsonb_build_object('nome', nome, 'preco_base', preco_base)) FROM produtos_precos WHERE nome ILIKE '%' || 'malha' || '%'),\n        'isopor', (SELECT jsonb_agg(jsonb_build_object('nome', nome, 'preco_base', preco_base)) FROM produtos_precos WHERE nome ILIKE '%' || 'isopor h7/33' || '%'),\n        'lajotas', (SELECT jsonb_agg(jsonb_build_object('nome', nome, 'preco_base', preco_base)) FROM produtos_precos WHERE nome ILIKE '%' || 'lajota' || '%')\n    ) AS todos_os_produtos;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -360,
        520
      ],
      "id": "2df612a0-543d-4f89-b08a-4635b81e44d6",
      "name": "preco"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a8d09a04-366c-4437-84ea-71af04d25142",
              "leftValue": "={{ $json.supervisor }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -700,
        860
      ],
      "id": "ffd484ba-6d94-4631-9e2b-268a9c98f632",
      "name": "If"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -1680,
        860
      ],
      "id": "312799e5-5be7-4644-9d39-e0aa24f3ea81",
      "name": "When chat message received",
      "webhookId": "4e20aa85-9b8f-4bf1-aa96-147bdfb044b4"
    },
    {
      "parameters": {
        "jsCode": "// A entrada do array de produtos agora vem de $input.first().json.json_agg\nconst produtosLista = $input.first().json.json_agg || [];\n\n// O nome do produto a ser buscado vem do primeiro item de sa√≠da do n√≥ 'Switch'\nconst nomeParaBuscar = $('Switch').first().json.NomeProduto || '';\n\n// --- Fun√ß√µes Auxiliares (mantidas iguais) ---\nfunction normalizeString(str) {\n    if (typeof str !== 'string') {\n        return '';\n    }\n    return str\n        .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\n        .toLowerCase()\n        .replace(/\\s+/g, ' ')\n        .trim();\n}\n\n/**\n * Nova Fun√ß√£o: Busca por todos os produtos que correspondem ao termo,\n * ordenando-os por relev√¢ncia.\n * @param {string} nomeProdutoBuscado - O nome do produto que se deseja buscar (ex: \"vergalh√£o\").\n * @param {Array<Object>} listaProdutos - O array de objetos de produtos.\n * @returns {Array<Object>} - Um array de objetos de produtos encontrados, ordenados por pontua√ß√£o.\n */\nfunction buscarTodosProdutosFlexivel(nomeProdutoBuscado, listaProdutos) {\n    const termoBuscadoNormalizado = normalizeString(nomeProdutoBuscado);\n    const termosSeparadosBuscado = termoBuscadoNormalizado.split(' ').filter(t => t.length > 1);\n\n    const resultadosCandidatos = [];\n\n    // Definir um LIMITE M√çNIMO DE PONTUA√á√ÉO para que um produto seja considerado relevante\n    // Ajuste este valor. Para buscar \"vergalh√£o\" e pegar todos, 1 ou 0.5 pode ser suficiente\n    // dependendo da pontua√ß√£o que voc√™ espera para uma √∫nica correspond√™ncia de palavra.\n    // Se quiser que apenas a palavra \"vergalhao\" j√° seja suficiente, 0.5 (se pontuado) ou 1.\n    const PONTUACAO_MINIMA_PARA_INCLUSAO = 0.5; // Ex: se apenas uma palavra como \"vergalhao\" √© encontrada\n\n    for (const produto of listaProdutos) {\n        const nomeProdutoNormalizado = normalizeString(produto.nome);\n        let pontuacaoAtual = 0;\n\n        // --- L√≥gica de Pontua√ß√£o (similar √† anterior) ---\n\n        // Prioriza correspond√™ncia exata ou quando o termo buscado est√° contido no nome do produto\n        if (nomeProdutoNormalizado === termoBuscadoNormalizado ||\n            nomeProdutoNormalizado.includes(termoBuscadoNormalizado) ||\n            termoBuscadoNormalizado.includes(nomeProdutoNormalizado)) {\n            pontuacaoAtual += 10; // Alta pontua√ß√£o para correspond√™ncia forte/exata\n        }\n\n        // Pontua por cada palavra encontrada\n        for (const termo of termosSeparadosBuscado) {\n            if (nomeProdutoNormalizado.includes(termo)) {\n                pontuacaoAtual++;\n            }\n        }\n\n        // Pontua√ß√£o extra para manter a categoria \"vergalhao\"\n        if (termoBuscadoNormalizado.includes('vergalhao') && nomeProdutoNormalizado.includes('vergalhao')) {\n            pontuacaoAtual += 2;\n        }\n        // Adicione outras categorias aqui se desejar (ex: 'malha', 'isopor')\n\n        // L√≥gica para priorizar bitolas pr√≥ximas (mantida para relev√¢ncia de ordem)\n        const bitolaBuscadaMatch = termoBuscadoNormalizado.match(/f(\\d+(\\.\\d+)?)/);\n        const bitolaProdutoMatch = nomeProdutoNormalizado.match(/f(\\d+(\\.\\d+)?)/);\n\n        if (bitolaBuscadaMatch && bitolaProdutoMatch) {\n            const bitolaBuscada = parseFloat(bitolaBuscadaMatch[1]);\n            const bitolaProduto = parseFloat(bitolaProdutoMatch[1]);\n            const diferencaBitola = Math.abs(bitolaBuscada - bitolaProduto);\n\n            if (diferencaBitola < 1) {\n                pontuacaoAtual += 1.5;\n            } else if (diferencaBitola < 3) {\n                pontuacaoAtual += 0.5;\n            }\n        }\n        // --- Fim da L√≥gica de Pontua√ß√£o ---\n\n        // Adiciona o produto aos resultados se a pontua√ß√£o for suficiente\n        if (pontuacaoAtual >= PONTUACAO_MINIMA_PARA_INCLUSAO) {\n            resultadosCandidatos.push({\n                produto: produto,\n                pontuacao: pontuacaoAtual\n            });\n        }\n    }\n\n    // Ordena os resultados pelos que t√™m maior pontua√ß√£o primeiro\n    resultadosCandidatos.sort((a, b) => b.pontuacao - a.pontuacao);\n\n    // Retorna apenas os objetos de produto, descartando a pontua√ß√£o extra\n    return resultadosCandidatos.map(item => item.produto);\n}\n\n// --- Execu√ß√£o da busca com NomeProduto do input ---\n// Agora chamamos a nova fun√ß√£o que retorna um ARRAY\nconst produtosEncontrados = buscarTodosProdutosFlexivel(nomeParaBuscar, produtosLista);\n\n// Objeto de detalhes padr√£o para garantir a estrutura completa\nconst defaultDetalhes = {\n    \"bitola\": \"\", \"modelo\": \"\", \"bitola_estribo\": \"\", \"espacamento_estribo\": \"\",\n    \"tamanho_estribo\": \"\", \"espacamento_fios\": \"\", \"tamanho\": \"\", \"altura\": \"\",\n    \"largura\": \"\", \"comprimento\": \"\", \"material\": \"\", \"codigo\": \"\",\n    \"referencia\": \"\", \"descricao\": \"\", \"tipo\": \"\", \"categoria\": \"\", \"tipo_uso\": \"\",\n    \"min\": null, \"max\": null, \"step\": null\n};\n\n// Mapeia os produtos encontrados para o formato de sa√≠da desejado\nconst saidaProdutosFormatados = produtosEncontrados.map(produto => {\n    let detalhesFinais = { ...defaultDetalhes, ...(produto.detalhes || {}) };\n\n    if (typeof produto.min !== 'undefined') detalhesFinais.min = produto.min;\n    if (typeof produto.max !== 'undefined') detalhesFinais.max = produto.max;\n    if (typeof produto.step !== 'undefined') detalhesFinais.step = produto.step;\n\n    return {\n        nome: produto.nome,\n        tipo_principal_produto: produto.tipo,\n        preco_base: parseFloat(produto.preco_base),\n        unidade: produto.unidade,\n        detalhes: detalhesFinais\n    };\n});\n\n\n// --- Retorno para o n8n ---\nreturn [\n    {\n        json: {\n            // Se voc√™ precisa dos detalhes do input original, pode adicion√°-los aqui\n            // Por exemplo, NomeProduto buscado:\n            nome_produto_buscado: nomeParaBuscar,\n            // Retorna o array de produtos encontrados\n            produtos_correspondentes: saidaProdutosFormatados,\n            // Uma flag para saber se algum produto foi encontrado\n            algum_produto_encontrado: saidaProdutosFormatados.length > 0\n        }\n    }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        0
      ],
      "id": "fffb63c0-aaae-4b16-b289-c11ad1515c00",
      "name": "Code3"
    }
  ],
  "connections": {
    "produtos_mais_cotados": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory SDR": {
      "ai_memory": [
        [
          {
            "node": "SDR",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "busca_preco": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ultimos_orcamentos": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "calcular_laje": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "calcular_ferragem_personalizada": {
      "ai_tool": [
        [
          {
            "node": "SDR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "SDR",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "ReadPreco",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ReadOrc",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CalcTotal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "preco",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CalcTotal": {
      "main": [
        [
          {
            "node": "InsertOrc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IfModoCalc": {
      "main": [
        [
          {
            "node": "CalcLajeC*L",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CalcLajeA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SDR": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "IfModoCalc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "preco": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "SDR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ReadPreco": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "operation": "preco_produto",
          "tableName": "produtos_precos",
          "especificacoes": null,
          "ferragem": null,
          "detalhes": {
            "bitola": "",
            "modelo": "",
            "bitola_estribo": "",
            "espacamento_estribo": "",
            "tamanho_estribo": "",
            "espacamento_fios": "",
            "tamanho": "",
            "altura": "",
            "largura": "",
            "comprimento": "",
            "material": "",
            "codigo": "",
            "referencia": "",
            "descricao": "",
            "tipo": "",
            "categoria": "",
            "tipo_uso": ""
          },
          "NomeProduto": "brita",
          "leadid": null,
          "Produtos": null,
          "Obs": null,
          "Status": null
        }
      }
    ]
  },
  "versionId": "e9d0d9a0-2d25-48f5-8998-82955a2faeb0",
  "triggerCount": 0,
  "tags": []
}