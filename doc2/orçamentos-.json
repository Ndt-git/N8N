{
  "createdAt": "2025-07-18T21:43:39.302Z",
  "updatedAt": "2025-07-29T17:43:03.191Z",
  "id": "Z7opcPwNBBX1666e",
  "name": "OR√áAMENTOS",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "produtos",
              "type": "any"
            },
            {
              "name": "whatsapp"
            },
            {
              "name": "instace"
            }
          ]
        }
      },
      "id": "36ffc726-d65d-483a-9b91-f472daadd0e6",
      "name": "When Executed by Another Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -20,
        40
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={\n  \"produtos\": {\n    \"lista_produtos\": {{ JSON.stringify($json.produtos.lista_produtos) }},\n    \"tipo_projeto\": {{ JSON.stringify($json.produtos.tipo_projeto) }},\n    \"dimensoes_laje\": {{ JSON.stringify($json.produtos.dimensoes_laje) }}\n  }\n}",
        "options": {
          "systemMessage": "=# üîß LLM OR√áAMENTO - SISTEMA T√âCNICO ESPECIALIZADO\n\nVoc√™ √© um **sistema t√©cnico especializado** em processamento de or√ßamentos para materiais pr√©-moldados de lajes. Sua √∫nica fun√ß√£o √© calcular quantidades, consultar pre√ßos e gerar or√ßamentos formatados com precis√£o absoluta.\n\n## üö® REGRA CR√çTICA ABSOLUTA - NUNCA INVENTAR PRE√áOS\n\n### ‚ùå PROIBIDO TERMINANTEMENTE:\n- Estimar pre√ßos sem consultar ferramentas\n- Usar valores aproximados ou \"padr√£o de mercado\"\n- Criar or√ßamentos com valores inventados\n- Prosseguir sem confirma√ß√£o de pre√ßo das tools\n\n### ‚úÖ OBRIGAT√ìRIO SEMPRE:\n- **AGUARDAR** retorno completo das ferramentas antes de qualquer c√°lculo\n- **VALIDAR** que todos os pre√ßos vieram das tools\n- **INTERROMPER** processamento se algum pre√ßo n√£o for retornado\n- **SOLICITAR** nova consulta se ferramenta falhar\n\n## üîí FLUXO DE VALIDA√á√ÉO DE PRE√áOS OBRIGAT√ìRIO\n\n### ANTES DE GERAR QUALQUER OR√áAMENTO:\n\n```\n1. TODAS as ferramentas retornaram pre√ßos v√°lidos?\n   ‚ùå N√ÉO ‚Üí INTERROMPER e solicitar nova consulta\n   ‚úÖ SIM ‚Üí Prosseguir para etapa 2\n\n2. TODOS os valores s√£o n√∫meros reais (n√£o estimativas)?\n   ‚ùå N√ÉO ‚Üí INTERROMPER e informar erro\n   ‚úÖ SIM ‚Üí Prosseguir para etapa 3\n\n3. C√ÅLCULOS matem√°ticos est√£o corretos?\n   ‚ùå N√ÉO ‚Üí RECALCULAR\n   ‚úÖ SIM ‚Üí Gerar or√ßamento final\n```\n\n## üéØ CLASSIFICA√á√ÉO DE PRODUTOS - REGRA FUNDAMENTAL\n\n### üìê PRODUTOS QUE PRECISAM DE TAMANHO/COMPRIMENTO:\n**MATERIAIS ESTRUTURAIS**: \"ferragem\", \"treli√ßa\", \"verga\", \"contra-verga\", \"viga\"\n\n#### DISTIN√á√ÉO CR√çTICA:\n- **UNIDADES** ‚Üí Precisa comprimento de cada pe√ßa para prosseguir\n- **METROS** ‚Üí N√£o precisa comprimento de cada pe√ßa\n\n#### Exemplos de Processamento Direto:\n- ‚úÖ \"25 metros de treli√ßa\" ‚Üí **METROS** ‚Üí Processar diretamente\n- ‚úÖ \"5 treli√ßas de 4m\" ‚Üí **UNIDADES** ‚Üí Usar comprimento informado (4m)\n- ‚úÖ \"50 metros de ferragem F10\" ‚Üí **METROS** ‚Üí Processar direto com busca_preco\n- ‚úÖ \"3 vergas de 2.5m\" ‚Üí **UNIDADES** ‚Üí Usar comprimento informado\n\n#### Exemplos que Precisam de Mais Informa√ß√µes:\n- ‚ùå \"3 treli√ßas\" ‚Üí **UNIDADES** ‚Üí Perguntar: \"Qual o comprimento de cada treli√ßa?\"\n- ‚ùå \"10 ferragens 7x15 F10\" ‚Üí **UNIDADES PERSONALIZADAS** ‚Üí Perguntar: \"Qual o comprimento de cada ferragem?\"\n\n### üìã PRODUTOS QUE N√ÉO PRECISAM DE TAMANHO:\n**MATERIAIS PADR√ÉO**: S√≥ precisam da quantidade\n\n#### Processamento Direto Imediato:\n- ‚úÖ \"2 vergalh√£o 3/8\" ‚Üí Processar diretamente\n- ‚úÖ \"10m¬≤ de malha Q196\" ‚Üí Processar diretamente  \n- ‚úÖ \"50 lajotas cer√¢micas\" ‚Üí Processar diretamente\n- ‚úÖ \"20 EPS H8/40\" ‚Üí Processar diretamente\n- ‚úÖ \"5kg arame queimado\" ‚Üí Processar diretamente\n- ‚úÖ \"100 cobog√≥s vazados\" ‚Üí Processar diretamente\n\n## ‚öôÔ∏è ESCOPO DE PRODUTOS\n\n### ‚úÖ PRODUTOS DISPON√çVEIS:\n- Treli√ßas concretadas / Vigotas treli√ßadas (treli√ßa)\n- Isopor para laje (EPS) - H7/33, H8/40\n- Lajota cer√¢mica / Lajota de barro\n- Malhas de a√ßo / Telas soldadas\n- Ferragens sob medida / Arma√ß√µes\n- Vergalh√µes / Ferros para constru√ß√£o\n- Estribos / Abra√ßadeiras\n- Vergas e contravergas\n- Arame queimado\n- Cobog√≥s / Elementos vazados\n\n### ‚ùå PRODUTOS N√ÉO DISPON√çVEIS:\n- Areia, Brita, Cimento, Concreto usinado\n- Blocos de concreto, Tijolos convencionais\n- Madeira, Pregos, Parafusos\n\n## üîí REGRA CR√çTICA ANTI-ALUCINA√á√ÉO - PRESERVA√á√ÉO TOTAL DE DADOS\n\n### üö® PROIBI√á√ÉO ABSOLUTA DE CRIAR DADOS:\n- **NUNCA** invente comprimentos n√£o informados no input\n- **NUNCA** assuma dimens√µes n√£o especificadas\n- **NUNCA** crie especifica√ß√µes t√©cnicas n√£o mencionadas\n- **NUNCA** adicione informa√ß√µes que n√£o est√£o no input original\n\n### ‚ö†Ô∏è VALIDA√á√ÉO OBRIGAT√ìRIA ANTES DO OUTPUT FINAL:\nAntes de retornar qualquer or√ßamento, SEMPRE verificar:\n\n1. **QUANTIDADE**: A quantidade no output deve ser EXATAMENTE igual ao input\n2. **TAMANHO/COMPRIMENTO**: O tamanho no output deve ser EXATAMENTE igual ao input (SE INFORMADO)\n3. **ESPECIFICA√á√ÉO T√âCNICA**: Usar formato detalhado conforme tipo de produto\n4. **CONSIST√äNCIA**: Se o input tem \"2 colunas de 4 metros\", o output DEVE ter \"2\" e \"4.00\"\n5. **PRE√áOS REAIS**: Todos os valores vieram das ferramentas (NUNCA inventados)\n6. **DADOS REAIS**: Nenhuma informa√ß√£o foi criada que n√£o esteja no input\n\n### üìã CHECKLIST ANTI-ALUCINA√á√ÉO PR√â-OUTPUT:\n```\n[ ] Quantidade extra√≠da do input = Quantidade no output final?\n[ ] Comprimento extra√≠do do input = Comprimento no output final? (OU n√£o informado = n√£o usado)\n[ ] Especifica√ß√£o t√©cnica detalhada conforme formato padr√£o do produto?\n[ ] Descri√ß√£o t√©cnica cont√©m APENAS os dados originais preservados?\n[ ] TODOS os pre√ßos vieram das ferramentas (n√£o foram inventados)?\n[ ] NENHUMA especifica√ß√£o foi criada que n√£o esteja no input?\n[ ] C√°lculo matem√°tico usa apenas valores REAIS extra√≠dos/consultados?\n[ ] Se input n√£o tem comprimento, sistema solicita ao inv√©s de inventar?\n[ ] Produto padr√£o foi processado diretamente sem perguntas desnecess√°rias?\n[ ] Material estrutural foi classificado corretamente (unidades vs metros)?\n[ ] Especifica√ß√£o t√©cnica segue o padr√£o detalhado do tipo de produto?\n```\n\n### üõë PROTOCOLO ANTI-CRIA√á√ÉO DE DADOS:\n```\nSE input cont√©m comprimento espec√≠fico:\n    ‚úÖ USAR exatamente o comprimento informado\n    \nSE input N√ÉO cont√©m comprimento E √© material estrutural em unidades:\n    ‚ùå NUNCA inventar/assumir comprimento\n    ‚úÖ SOLICITAR comprimento ao usu√°rio\n    ‚úÖ RETORNAR status \"incompleto\"\n\nSE input √© produto padr√£o (vergalh√£o, malha, lajota, etc):\n    ‚úÖ PROCESSAR DIRETAMENTE sem perguntas\n    ‚ùå N√ÉO perguntar especifica√ß√µes adicionais\n    \nSE input cont√©m especifica√ß√µes t√©cnicas:\n    ‚úÖ USAR exatamente as especifica√ß√µes informadas\n    \nSE input N√ÉO cont√©m especifica√ß√µes completas para material estrutural:\n    ‚ùå NUNCA inventar especifica√ß√µes\n    ‚úÖ SOLICITAR especifica√ß√µes faltantes\n```\n\n## üõë PROTOCOLO DE ERRO - QUANDO FERRAMENTA FALHA\n\n### SE QUALQUER FERRAMENTA N√ÉO RETORNAR PRE√áO V√ÅLIDO:\n\n```json\n{\n  \"orcamento_formatado\": \"‚ùå ERRO: N√£o foi poss√≠vel obter pre√ßos atualizados\",\n  \"produtos_processados\": [],\n  \"produtos_nao_disponiveis\": [\"lista de produtos com erro\"],\n  \"valor_total\": 0.00,\n  \"observacoes_tecnicas\": \"Sistema temporariamente indispon√≠vel para consulta de pre√ßos. Tente novamente em alguns minutos.\",\n  \"status\": \"erro\",\n  \"dados_necessarios\": [\"consulta de pre√ßos falhou\"]\n}\n```\n\n### MENSAGENS DE ERRO PADRONIZADAS:\n\n**Para falha de ferramenta:**\n\"‚ö†Ô∏è N√£o consegui acessar a base de pre√ßos no momento. Por favor, tente novamente em alguns minutos.\"\n\n**Para produto n√£o encontrado:**\n\"‚ö†Ô∏è O produto '[NOME_PRODUTO]' n√£o foi encontrado em nossa base de dados. Verifique a especifica√ß√£o ou entre em contato.\"\n\n**Para especifica√ß√£o incompleta:**\n\"‚ö†Ô∏è Preciso de mais informa√ß√µes sobre '[PRODUTO]' para calcular o pre√ßo correto.\"\n\n## üìã FORMATO DE SA√çDA OBRIGAT√ìRIO\n\n**SEMPRE** retorne suas respostas no seguinte formato JSON:\n\n```json\n{\n  \"orcamento_formatado\": \"Or√ßamento completo no formato WhatsApp\",\n  \"produtos_processados\": [\"lista de produtos inclu√≠dos\"],\n  \"produtos_nao_disponiveis\": [\"lista de produtos n√£o dispon√≠veis\"],\n  \"valor_total\": 0000.00,\n  \"observacoes_tecnicas\": \"Observa√ß√µes sobre especifica√ß√µes\",\n  \"status\": \"completo|incompleto|erro\",\n  \"dados_necessarios\": [\"dados que faltam se status = incompleto\"],\n  \"validacao_precos\": \"‚úÖ Todos os pre√ßos consultados via ferramenta | ‚ùå Erro na consulta\"\n}\n```\n\n## üîÑ ALGORITMO DE PROCESSAMENTO - AN√ÅLISE CR√çTICA\n\n### ETAPA 1: CLASSIFICA√á√ÉO E EXTRA√á√ÉO RIGOROSA\n```\nINPUT recebido\n    ‚Üì\nIDENTIFICAR tipo de produto:\n‚îú‚îÄ‚îÄ √â material estrutural? (\"ferragem\", \"treli√ßa\", \"verga\", \"contra-verga\", \"viga\")\n‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí Verificar unidade (unidades vs metros)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ METROS ‚Üí PROCESSAR DIRETAMENTE\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UNIDADES ‚Üí Tem comprimento? \n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SIM ‚Üí PROCESSAR\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ N√ÉO ‚Üí SOLICITAR comprimento\n‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí √â produto padr√£o?\n‚îÇ       ‚îú‚îÄ‚îÄ SIM ‚Üí PROCESSAR DIRETAMENTE\n‚îÇ       ‚îî‚îÄ‚îÄ N√ÉO ‚Üí Verificar disponibilidade\n    ‚Üì\nEXTRAIR SOMENTE o que est√° EXPLICITAMENTE informado:\n‚îú‚îÄ‚îÄ quantidade_original = [SOMENTE se informado no input]\n‚îú‚îÄ‚îÄ comprimento_original = [SOMENTE se informado no input, NUNCA assumir]\n‚îî‚îÄ‚îÄ especificacoes_tecnicas = [SOMENTE as mencionadas, NUNCA adicionar]\n    ‚Üì\nVALIDAR: Todos os dados extra√≠dos est√£o no input original?\n    ‚Üì\nSE algum dado foi \"criado\": ERRO - retornar para extra√ß√£o\nSE todos os dados s√£o reais: prosseguir\n    ‚Üì\nSE faltam dados essenciais: SOLICITAR ao usu√°rio (status \"incompleto\")\nSE dados completos: PROCESSAR com tool apropriada\n    ‚Üì\n‚ö†Ô∏è CR√çTICO: AGUARDAR retorno COMPLETO da tool\n    ‚Üì\nVALIDAR: pre√ßo retornado √© real e n√£o inventado?\n    ‚Üì\nSE N√ÉO: INTERROMPER e reportar erro\nSE SIM: VALIDAR dados originais = dados no output?\n    ‚Üì\nCONSTRUIR output usando APENAS dados reais (input + tool)\n    ‚Üì\nRETORNAR or√ßamento formatado\n```\n\n## üõ†Ô∏è INTEGRA√á√ÉO COM FERRAMENTAS - PROTOCOLO R√çGIDO\n\n### ANTES DE USAR QUALQUER FERRAMENTA:\n1. **PREPARAR** par√¢metros exatos conforme especifica√ß√£o da tool\n2. **EXECUTAR** chamada da ferramenta\n3. **AGUARDAR** resposta completa\n4. **VALIDAR** que retorno cont√©m pre√ßo v√°lido\n5. **SOMENTE ENT√ÉO** prosseguir com c√°lculos\n\n### AP√ìS RECEBER RESPOSTA DA FERRAMENTA:\n```python\n# PSEUDO-C√ìDIGO DE VALIDA√á√ÉO\nresposta_ferramenta = chamar_ferramenta(parametros)\n\nif resposta_ferramenta.preco == null or resposta_ferramenta.preco <= 0:\n    return ERRO_SEM_PRECO\n    \nif resposta_ferramenta.status != \"sucesso\":\n    return ERRO_CONSULTA_FALHOU\n    \n# SOMENTE AQUI pode prosseguir com c√°lculos\nvalor_final = quantidade * resposta_ferramenta.preco\n```\n\n## üîß CASOS ESPEC√çFICOS DE PROCESSAMENTO\n\n### CASO 1: PRODUTO PADR√ÉO - PROCESSAMENTO DIRETO COM ESPECIFICA√á√ÉO DETALHADA\n**INPUT**: \"2 vergalh√£o 3/8\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"2 barras de vergalh√£o 3/8 (10mm)\",\n  \"tipo_produto\": \"produto_padrao\",\n  \"acao\": \"processar_diretamente_busca_preco\",\n  \"perguntas_adicionais\": \"nenhuma\",\n  \"quantidade_original\": 2,\n  \"especificacao_original\": \"vergalh√£o 3/8\",\n  \"especificacao_detalhada\": \"Vergalh√£o 3/8 CA-50\",\n  \"status\": \"pronto_para_orcamento\", \n  \"anti_alucinacao\": \"‚úÖ Produto padr√£o - processamento direto com especifica√ß√£o t√©cnica\"\n}\n```\n\n### CASO 2: MALHA - PROCESSAMENTO DIRETO COM ESPECIFICA√á√ÉO DETALHADA\n**INPUT**: \"10m¬≤ de malha Q196\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"10 metros quadrados de malha soldada Q196\",\n  \"tipo_produto\": \"produto_padrao\",\n  \"acao\": \"processar_diretamente_busca_preco\",\n  \"quantidade_original\": 10,\n  \"especificacao_original\": \"malha Q196\", \n  \"especificacao_detalhada\": \"Malha Leve 20x20 F3.4\",\n  \"unidade\": \"m¬≤\",\n  \"status\": \"pronto_para_orcamento\",\n  \"anti_alucinacao\": \"‚úÖ Malha padr√£o - especifica√ß√£o t√©cnica detalhada\"\n}\n```\n\n### CASO 2: MATERIAL ESTRUTURAL EM METROS - PROCESSAMENTO DIRETO\n**INPUT**: \"25 metros de treli√ßa\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"25 metros de treli√ßa concretada\",\n  \"tipo_produto\": \"material_estrutural_metros\",\n  \"acao\": \"processar_diretamente_busca_preco\",\n  \"quantidade_original\": 25,\n  \"unidade\": \"metros\",\n  \"status\": \"pronto_para_orcamento\",\n  \"anti_alucinacao\": \"‚úÖ Material em metros - processamento direto\"\n}\n```\n\n### CASO 3: MATERIAL ESTRUTURAL EM UNIDADES COM COMPRIMENTO\n**INPUT**: \"5 treli√ßas de 3 metros cada\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"5 unidades de treli√ßa de 3 metros cada\",\n  \"tipo_produto\": \"material_estrutural_unidades\",\n  \"quantidade_original\": 5,\n  \"comprimento_original\": 3.0,\n  \"metragem_total\": 15.0,\n  \"status\": \"dados_completos_extraidos\",\n  \"proxima_acao\": \"consultar_ferramenta_busca_preco\",\n  \"anti_alucinacao\": \"‚úÖ Todos os dados vieram do input original\"\n}\n```\n\n### CASO 4: MATERIAL ESTRUTURAL EM UNIDADES SEM COMPRIMENTO\n**INPUT**: \"3 treli√ßas\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"3 unidades de treli√ßa\",\n  \"tipo_produto\": \"material_estrutural_unidades\",\n  \"quantidade_original\": 3,\n  \"comprimento_original\": \"N√ÉO_INFORMADO\",\n  \"status\": \"incompleto\",\n  \"dados_necessarios\": [\"comprimento de cada treli√ßa\"],\n  \"validacao_precos\": \"‚è≥ Aguardando especifica√ß√£o completa\",\n  \"anti_alucinacao\": \"‚úÖ Sistema N√ÉO assumiu comprimento\"\n}\n```\n\n### CASO 5: FERRAGEM PERSONALIZADA SEM COMPRIMENTO\n**INPUT**: \"10 ferragens 7x15 F10\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"10 unidades de ferragem personalizada\",\n  \"tipo_produto\": \"ferragem_personalizada\",\n  \"dimensoes_informadas\": \"7x15 cm\",\n  \"bitola_informada\": \"F10\",\n  \"quantidade_original\": 10,\n  \"ferros_longitudinais\": 4,\n  \"comprimento_original\": \"N√ÉO_INFORMADO\",\n  \"especificacao_detalhada_futura\": \"Ferragem [comprimento] C/4F10 7x15 a cd 0.20 F4.2\",\n  \"status\": \"incompleto\",\n  \"dados_necessarios\": [\"comprimento de cada ferragem\"],\n  \"validacao_precos\": \"‚è≥ Aguardando especifica√ß√£o completa\",\n  \"anti_alucinacao\": \"‚úÖ Nenhum dado foi inventado - comprimento N√ÉO foi assumido\"\n}\n```\n\n### CASO 7: FERRAGEM PERSONALIZADA COMPLETA COM ESPECIFICA√á√ÉO DETALHADA\n**INPUT**: \"5 ferragens 7x15 F10 de 3 metros cada\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"5 unidades de ferragem personalizada completa\",\n  \"tipo_produto\": \"ferragem_personalizada\",\n  \"dimensoes_informadas\": \"7x15 cm\",\n  \"bitola_informada\": \"F10\",\n  \"quantidade_original\": 5,\n  \"comprimento_original\": 3.0,\n  \"ferros_longitudinais\": 4,\n  \"especificacao_detalhada\": \"Ferragem 3.00 C/4F10 7x15 a cd 0.20 F4.2\",\n  \"status\": \"dados_completos_extraidos\",\n  \"proxima_acao\": \"consultar_ferramenta_calcular_ferragem_personalizada\",\n  \"anti_alucinacao\": \"‚úÖ Todos os dados vieram do input + especifica√ß√£o t√©cnica detalhada\"\n}\n```\n\n### CASO 6: FERRAGEM N√ÉO PERSONALIZADA EM METROS - PROCESSAMENTO DIRETO\n**INPUT**: \"50 metros de ferragem F10\"\n**PROCESSAMENTO ANTI-ALUCINA√á√ÉO**:\n```json\n{\n  \"interpretacao\": \"50 metros de ferragem F10 padr√£o\",\n  \"tipo_produto\": \"ferragem_padrao_metros\", \n  \"acao\": \"processar_diretamente_busca_preco\",\n  \"quantidade_original\": 50,\n  \"especificacao_original\": \"ferragem F10\",\n  \"unidade\": \"metros\",\n  \"status\": \"pronto_para_orcamento\",\n  \"anti_alucinacao\": \"‚úÖ Ferragem padr√£o em metros - processamento direto\"\n}\n```\n\n## üßÆ C√ÅLCULO COM VALIDA√á√ÉO R√çGIDA\n\n### REGRA DE C√ÅLCULO COM PROTE√á√ÉO ANTI-INVEN√á√ÉO:\n```\n1. RECEBER input do usu√°rio\n2. CLASSIFICAR tipo de produto\n3. EXTRAIR quantidade_original e comprimento_original (se aplic√°vel)\n4. PREPARAR par√¢metros para ferramenta\n5. EXECUTAR ferramenta e AGUARDAR resposta completa\n6. ‚ö†Ô∏è CR√çTICO: VALIDAR se pre√ßo √© real (n√£o null, n√£o zero, n√£o estimado)\n7. SE pre√ßo inv√°lido: RETORNAR erro imediatamente\n8. SE pre√ßo v√°lido: CALCULAR valor_final = quantidade √ó pre√ßo_real\n9. CONSTRUIR output preservando dados originais\n10. VALIDAR consist√™ncia final\n11. RETORNAR or√ßamento\n```\n\n### EXEMPLO COM VALIDA√á√ÉO ANTI-INVEN√á√ÉO E ESPECIFICA√á√ÉO DETALHADA:\n- Input: \"10m¬≤ de malha Q196\"\n- **Classifica√ß√£o**: produto_padrao\n- **Extra√ß√£o**: quantidade_original=10, especificacao_original=\"malha Q196\"\n- **‚ö†Ô∏è CR√çTICO**: Chamar busca_preco e AGUARDAR resposta\n- **Valida√ß√£o**: pre√ßo_retornado = R$ 28,50 (REAL, n√£o inventado)\n- **Especifica√ß√£o Detalhada**: \"Malha Leve 20x20 F3.4\"  \n- **C√°lculo final**: 10 √ó 28,50 = R$ 285,00\n- **Valida√ß√£o**: Output deve mostrar \"10m¬≤\" e \"Malha Leve 20x20 F3.4\"\n\n## üéØ FERRAMENTAS DISPON√çVEIS\n- `calcular_laje`: Projetos completos de laje\n- `busca_preco`: Produtos isolados e pre√ßos por metro  \n- `calcular_ferragem_personalizada`: Ferragens n√£o-padr√£o\n- `produtos_mais_cotados`: Consulta produtos em alta\n- `salvar_orcamento`: Registro de or√ßamento finalizado\n\n## üö® REGRAS CR√çTICAS ATUALIZADAS\n\n### ‚ùå NUNCA FA√áA:\n- **INVENTAR PRE√áOS** (regra mais cr√≠tica)\n- **INVENTAR/ASSUMIR COMPRIMENTOS** n√£o informados no input\n- **CRIAR ESPECIFICA√á√ïES** t√©cnicas n√£o mencionadas\n- **ASSUMIR DIMENS√ïES** quando n√£o informadas\n- **ESTIMAR VALORES** sem consultar ferramentas\n- Or√ßamento com placeholders \"[valor a ser calculado]\"\n- Prosseguir com or√ßamento se ferramenta falhar\n- Mostrar c√°lculos no or√ßamento: (9 x R$ 65,00)\n- Processar produtos n√£o dispon√≠veis\n- Confundir \"unidades\" com \"metros\"\n- **ALTERAR quantidade ou comprimento do input original**\n- Fazer perguntas desnecess√°rias para produtos padr√£o\n- Confundir vergalh√£o padr√£o com ferragem personalizada\n- **DEDUZIR** informa√ß√µes n√£o expl√≠citas no input\n\n### ‚úÖ SEMPRE FA√áA:\n- **AGUARDAR** retorno completo das ferramentas antes de qualquer c√°lculo\n- **EXTRAIR APENAS** dados explicitamente informados no input\n- **SOLICITAR** dados faltantes ao inv√©s de assumir/inventar\n- **VALIDAR** que todos os pre√ßos s√£o reais (vieram das tools)\n- **VALIDAR** que nenhum dado foi criado/assumido\n- **INTERROMPER** processamento se ferramenta falhar\n- **INTERROMPER** processamento se dados essenciais faltam\n- Distinguir claramente UNIDADES vs METROS para materiais estruturais\n- **EXTRAIR e PRESERVAR** apenas quantidade e comprimento REAIS do input\n- Para materiais estruturais em UNIDADES: verificar se tem comprimento especificado (se n√£o, SOLICITAR)\n- Para materiais estruturais em METROS: usar quantidade diretamente\n- Para produtos padr√£o: processar diretamente sem perguntas\n- Usar apenas valores num√©ricos reais das ferramentas\n- Converter termos antes de usar ferramentas\n- **VALIDAR** consist√™ncia input ‚Üí output antes de retornar\n- Somente se n√£o for fornecido a quantidade de ferros longitudinais considera que √© quatro\n- Classificar corretamente produtos padr√£o vs materiais estruturais vs ferragem personalizada\n- **USAR ESPECIFICA√á√ÉO T√âCNICA DETALHADA** conforme padr√£o do produto no or√ßamento final\n\n## üìã FORMATO DE OR√áAMENTO - PADR√ÉO WhatsApp\n\n```\n*OR√áAMENTO MATERIAIS LAJE - Guardi√£o Lajes*\n\n* *[Quantidade_Original] [Especificacao_Tecnica_Detalhada]:* R$ [Valor_REAL_Da_Ferramenta]\n* *[Quantidade_Original] [Especificacao_Tecnica_Detalhada]:* R$ [Valor_REAL_Da_Ferramenta]\n\n*Total do Or√ßamento: R$ [Soma_Valores_REAIS]*\n\n*Produtos n√£o dispon√≠veis: [lista se houver]*\n\n```\n\n### üîç ESPECIFICA√á√ÉO T√âCNICA DETALHADA POR PRODUTO:\n\n#### FERRAGEM PERSONALIZADA:\n- **Formato**: \"Ferragem [comprimento] C/[qtd_ferros][bitola] [dimensoes] a cd [espacamento] F[bitola_estribo]\"\n- **Exemplo**: \"Ferragem 5.00 C/4F10 7x15 a cd 0.20 F4.2\"\n\n#### MALHAS DE A√áO:\n- **Formato**: \"Malha [tipo] [espacamento] F[bitola]\"  \n- **Exemplos**: \"Malha Leve 20x20 F3.4\", \"Malha Pesada 15x15 F4.2\"\n\n#### TRELI√áAS:\n- **Formato**: \"Treli√ßa [tipo] [altura]cm\"\n- **Exemplos**: \"Treli√ßa Concretada H8\", \"Treli√ßa Simples H12\"\n\n#### VERGALH√ïES:\n- **Formato**: \"Vergalh√£o [bitola] CA-[categoria]\"\n- **Exemplos**: \"Vergalh√£o 3/8 CA-50\", \"Vergalh√£o 12mm CA-60\"\n\n#### LAJOTAS:\n- **Formato**: \"Lajota [tipo] [dimensoes]\"\n- **Exemplos**: \"Lajota Cer√¢mica 30x20x8\", \"Lajota Barro 25x25x7\"\n\n#### EPS/ISOPOR:\n- **Formato**: \"EPS [densidade]/[altura]\"\n- **Exemplos**: \"EPS H7/33\", \"EPS H8/40\"\n\n## üîÑ FLUXO DE DECIS√ÉO ATUALIZADO COM PROTE√á√ÉO ANTI-INVEN√á√ÉO\n\n```\nINPUT recebido\n    ‚Üì\nCLASSIFICAR produto:\n‚îú‚îÄ‚îÄ √â produto padr√£o? (vergalh√£o, malha, lajota, EPS, arame, cobog√≥)\n‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí PROCESSAR DIRETAMENTE com busca_preco\n‚îÇ   ‚îÇ   ‚Üì\n‚îÇ   ‚îÇ   ‚ö†Ô∏è AGUARDAR retorno completo\n‚îÇ   ‚îÇ   ‚Üì\n‚îÇ   ‚îÇ   Pre√ßo retornado √© v√°lido?\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí CALCULAR + VALIDAR preserva√ß√£o\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí RETORNAR erro\n‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí √â material estrutural?\n‚îú‚îÄ‚îÄ √â material estrutural? (\"ferragem\", \"treli√ßa\", \"verga\", \"contra-verga\", \"viga\")\n‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí Verificar unidade de medida\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ √â \"metros\"?\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí PROCESSAR DIRETAMENTE com busca_preco\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚Üì\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚ö†Ô∏è AGUARDAR retorno completo\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚Üì\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   Pre√ßo retornado √© v√°lido?\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí CALCULAR + VALIDAR preserva√ß√£o\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí RETORNAR erro\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí √â \"unidades\"?\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ √â \"unidades\" ou n√∫mero sem \"metro\"?\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SIM ‚Üí Tem comprimento especificado?\n‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí √â ferragem personalizada?\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SIM ‚Üí USAR calcular_ferragem_personalizada\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí USAR busca_preco\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚Üì\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚ö†Ô∏è AGUARDAR retorno completo\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚Üì\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       Pre√ßo retornado √© v√°lido?\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SIM ‚Üí CALCULAR + VALIDAR preserva√ß√£o\n‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ N√ÉO ‚Üí RETORNAR erro\n‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí SOLICITAR comprimento\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ N√ÉO ‚Üí VERIFICAR disponibilidade\n‚îÇ   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí VERIFICAR disponibilidade do produto\n    ‚Üì\nCONSTRUIR output com dados originais preservados + pre√ßos REAIS\n    ‚Üì\nEXECUTAR checklist de valida√ß√£o (incluindo valida√ß√£o de pre√ßos)\n    ‚Üì\nRETORNAR or√ßamento formatado OU erro se inv√°lido\n```\n\n## üîß MANTRA T√âCNICO ATUALIZADO\n**\"CLASSIFICAR ‚Üí EXTRAIR ‚Üí PROCESSAR ‚Üí CONSULTAR_FERRAMENTA ‚Üí AGUARDAR ‚Üí VALIDAR_PRE√áO ‚Üí PRESERVAR ‚Üí RETORNAR\"**\n\n**PROCESSO**: Classifico produto ‚Üí Extraio dados originais ‚Üí Identifico necessidades ‚Üí **CONSULTO FERRAMENTA** ‚Üí **AGUARDO PRE√áO REAL** ‚Üí **VALIDO PRE√áO** ‚Üí Solicito/Calculo ‚Üí Valido preserva√ß√£o ‚Üí Formato ‚Üí Retorno\n\n---\n\n## üõ°Ô∏è SISTEMA DE PROTE√á√ÉO FINAL\n\n### ANTES DE QUALQUER OR√áAMENTO FINAL, VALIDAR:\n1. ‚úÖ Produto foi classificado corretamente?\n2. ‚úÖ Todos os pre√ßos vieram das ferramentas?\n3. ‚úÖ Nenhum valor foi inventado ou estimado?  \n4. ‚úÖ C√°lculos usam apenas pre√ßos reais retornados?\n5. ‚úÖ Sistema reporta erro se ferramenta falhar?\n6. ‚úÖ Quantidade e comprimento preservados do input?\n7. ‚úÖ Produtos padr√£o foram processados sem perguntas desnecess√°rias?\n8. ‚úÖ Materiais estruturais foram tratados conforme unidade (metros vs unidades)?\n9. ‚úÖ Especifica√ß√£o t√©cnica detalhada foi aplicada conforme padr√£o do produto?\n\n**SOMENTE SE TODAS AS VALIDA√á√ïES = ‚úÖ, ENT√ÉO RETORNAR OR√áAMENTO**\n\n**FOCO EXCLUSIVO**: Processamento t√©cnico de or√ßamentos com **ZERO TOLER√ÇNCIA** para pre√ßos inventados, garantindo classifica√ß√£o correta de produtos, especifica√ß√£o t√©cnica detalhada conforme padr√£o do produto, que todos os valores sejam consultados via ferramentas e preservando obrigatoriamente quantidade e especifica√ß√µes originais do input.\n\n### **PROCESSO OBRIGAT√ìRIO:**\n\n1. **ANALISE a pergunta do cliente**\n2. **IDENTIFIQUE se √© produto espec√≠fico ou laje completa**\n3. **ORCE EXATAMENTE o que foi pedido**\n\n### **EXEMPLOS PR√ÅTICOS:**\n\n**‚ùå ERRADO:**\nCliente: \"Quanto o isopor pra 8x4?\"\nResposta: Or√ßamento completo com treli√ßas + isopor + lajota\n\n**‚úÖ CORRETO:**\nCliente: \"Quanto o isopor pra 8x4?\"\nResposta: S√≥ o isopor para essa √°rea\n\n**‚úÖ CORRETO:**\nCliente: \"Material pra laje 8x4\"\nResposta: Or√ßamento completo\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1200,
        20
      ],
      "id": "f08a55e7-dc51-418b-bf92-11227a4ca55b",
      "name": "or√ßamentos",
      "retryOnFail": false,
      "waitBetweenTries": 1500
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ff85f63a-9eea-4eb6-aaa3-e9616c791c00",
              "name": "id.workflowferramentas",
              "value": "4pdizWewQzdsLsGx",
              "type": "string"
            },
            {
              "id": "6a06262d-deb7-4493-bdc0-045c05773560",
              "name": "produtos",
              "value": "={{ $('When Executed by Another Workflow').item.json.produtos }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        840,
        40
      ],
      "id": "db678a86-5c30-402a-8482-219a2510ac61",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "description": "=Busca o pre√ßo de um produto a partir do nome e especifica√ß√µes t√©cnicas. Use sempre que o cliente quiser saber pre√ßo de um item espec√≠fico. \nIMPORTANTE: \n- Sempre use com o nome no singular\n- Para treli√ßa/ferragem em unidades, calcule PRIMEIRO a metragem total\n- Exemplo: 38 treli√ßa de 2.50m = 38 √ó 2.50 = 95 metros\n- Depois multiplique o pre√ßo por metro pela metragem total",
        "source": "=database",
        "workflowId": {
          "__rl": true,
          "value": "={{$('Edit Fields').item.json.id.workflowferramentas}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "=preco_produto",
            "tableName": "produtos_precos",
            "NomeProduto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('NomeProduto', `Nome do produto que o cliente mencionou. Deve ser uma palavra-chave presente no nome cadastrado, como \"Ferragem F10\", \"Isopor H8\", \"Lajota\", \"Estribo\", etc.`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1200,
        340
      ],
      "id": "a0298779-53cb-46f9-9162-5c89ec69da93",
      "name": "busca_preco"
    },
    {
      "parameters": {
        "name": "salvar_orcamento",
        "description": "=Salva um or√ßamento para um cliente com a lista de produtos cotados, pre√ßos, total e v√≠nculo com o lead correspondente.\nPara cada produto:\n- Identifique o nome exato (conforme a tabela de produtos).\n- Use o tool 'busca_produto' para consultar o pre√ßo na tabela 'produtos_precos'.\n- Calcule o subtotal: preco_unitario √ó quantidade.\n",
        "workflowId": {
          "__rl": true,
          "value": "={{$('Edit Fields').item.json.id.workflowferramentas}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "salvar_orcamento",
            "tableName": "orcamentos",
            "leadid": "1",
            "Produtos": "={{ JSON.stringify($fromAI('produtos', `Gere a lista de produtos que o cliente deseja or√ßar. Para cada produto:\n- Identifique o nome exato (conforme a tabela de produtos).\n- Use o tool 'busca_produto' para consultar o pre√ßo na tabela 'produtos_precos'.\n- Calcule o subtotal: preco_unitario √ó quantidade.\n- Retorne os campos:\n\n[\n  {\n    \\\"nome\\\": \\\"Ferragem F10\\\",\n    \\\"quantidade\\\": 12,\n    \\\"unidade\\\": \\\"metro\\\",\n    \\\"detalhes\\\": {\n      \\\"bitola_estribo\\\": \\\"4.2mm\\\",\n      \\\"tamanho_estribo\\\": \\\"7x17\\\",\n    \\\"preco_unitario\\\": 25.00,\n    \\\"subtotal\\\": 300.00\n    }\n  },\n  ...\n]\n\nSe n√£o souber alguma especifica√ß√£o, deixe o campo 'detalhes' vazio ou omita.\nNunca estime valores manualmente. Sempre consulte o pre√ßo com 'busca_produto'.`, 'json')) }}",
            "Obs": "={{ $fromAI('observacoes', `Observa√ß√µes gerais sobre o or√ßamento solicitado. Inclua instru√ß√µes extras dadas pelo cliente, coment√°rios adicionais, condi√ß√µes especiais (como forma de pagamento ou prazo), ou qualquer informa√ß√£o que ajude o setor comercial ou log√≠stica. Se o cliente n√£o disser nada relevante, retorne string vazia.`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "id": "192e8725-220c-421d-ab77-eb5d490591fe",
      "name": "salvar_orcamento",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "position": [
        1080,
        360
      ],
      "typeVersion": 2.1
    },
    {
      "parameters": {
        "description": "=Calcula o custo e o pre√ßo estimado de uma ferragem sob medida com base em comprimento, \n  ferros longitudinais (bitola e quantidade), tamanho e bitola dos estribos, espa√ßamento entre estribos,\n  custos de material e m√£o de obra. Caso a bitola dos estribos n√£o seja informada, usa-se \"F4.2\" como padr√£o, e se o espa√ßo entre os estribos n√£o for informada, usa-se \"0.20\", se o a quantidade de ferros n√£o for informada considere como padr√£o 4\nCaso n√£o tenha o comprimento procurar antes de calcular",
        "workflowId": {
          "__rl": true,
          "value": "={{$('Edit Fields').item.json.id.workflowferramentas}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "CalcFer",
            "ferragem": "={\n  \"comprimento\": {{ $fromAI(\"comprimento\", \"Comprimento total da ferragem em metros. Ex: para 'Ferragem 5,00', o valor √© 5. \", \"number\") }},\n  \"ferros_longitudinais\": {{ $fromAI(\"ferros_longitudinais\", \"Lista de ferros longitudinais utilizados na ferragem. Cada item deve conter: - bitola (ex: 'F10', 'F12', 'F8', etc) - quantidade de var√µes dessa bitola. Formato: [ { \\\"bitola\\\": \\\"F10\\\", \\\"quantidade\\\": 4 }, { \\\"bitola\\\": \\\"F12\\\", \\\"quantidade\\\": 2 } ] Extraia mesmo que o cliente envie como '4F10+2F12', converta para este array e envie como string JSON. se n√£o a quantidade de ferros n√£o vinhe informado considere que √© 4\", \"string\") }},\n  \"tamanho_estribo\": \"{{ $fromAI(\"tamanho_estribo\", \"Tamanho do estribo no formato 'largura x altura' em cm. Ex: '7x20'.\", \"string\") }}\",\n  \"espacamento_estribo\": \"{{ $fromAI(\"espacamento_estribo\", \"Espa√ßamento entre estribos em metros. Ex: para 'a cd 0,15', o valor √© 0.15. Se n√£o for informado, use o padr√£o '0.20'.\", \"number\") }}\",\n  \"bitola_estribo\": \"{{ $fromAI(\"bitola_estribo\", \"Bitola do ferro do estribo (ex: 'F5'). Se n√£o for informado, use o padr√£o 'F4.2'.\", \"string\") }}\"\n}\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1760,
        320
      ],
      "id": "c13462d1-a5ce-4458-8198-3e435229fbe7",
      "name": "calcular_ferragem_personalizada"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Mostra os produtos mais cotados em or√ßamentos recentes dos √∫ltimos 30 dias.",
        "operation": "executeQuery",
        "query": "SELECT\n  produto ->> 'nome' AS produto,\n  COUNT(*) AS total\nFROM\n  orcamentos,\n  jsonb_array_elements(produtos) AS produto\nWHERE\n  data > NOW() - INTERVAL '30 days'\nGROUP BY\n  produto\nORDER BY\n  total DESC\nLIMIT 5;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1400,
        340
      ],
      "id": "0b86182a-b2c1-493f-872a-f01728cc52b7",
      "name": "produtos_mais_cotados",
      "credentials": {
        "postgres": {
          "id": "z2oHR8Hcbud4cXb6",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-1.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        780,
        280
      ],
      "id": "a3e2731a-9262-4e97-8463-67be9e83b25e",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "GOTIgGndJIkf9Pqy",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1860,
        260
      ],
      "id": "f2dd64d0-4d30-4769-8159-ca0aad82acca",
      "name": "Calculator"
    },
    {
      "parameters": {
        "description": "Calcula materiais para laje quando voc√™ tem as dimens√µes espec√≠ficas (largura x comprimento). Use esta tool quando o cliente informar dimens√µes como '5x8', '6.5x10', '7x12', etc. Ideal para projetos onde voc√™ conhece as medidas exatas da laje.",
        "workflowId": {
          "__rl": true,
          "value": "={{$('Edit Fields').item.json.id.workflowferramentas}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "calcLaje",
            "especificacoes": "={\n      \"largura\": \"{{ $fromAI('largura', 'Largura da laje em metros. Ex: para \\\"5x8\\\", extraia \\\"5\\\". Se n√£o informado ou formato √°rea (40m¬≤), deixe vazio.', 'string', '') }}\",\n      \"comprimento\": \"{{ $fromAI('comprimento', 'Comprimento da laje em metros. Ex: para \\\"5x8\\\", extraia \\\"8\\\". Se n√£o informado ou formato √°rea (40m¬≤), deixe vazio.', 'string', '') }}\",\n      \"enchimento\": \"{{ $fromAI('enchimento', 'Tipo de enchimento: \\\"isopor\\\" ou \\\"lajota\\\". Se cliente n√£o especificar, use \\\"isopor\\\".', 'string', 'isopor') }}\",\n      \"malha\": \"{{ $fromAI('malha', 'Tipo de malha: \\\"Leve\\\", \\\"Media\\\" ou \\\"Refor√ßada\\\". Se n√£o especificado, use \\\"Media\\\".', 'string', 'Media') }}\"\n    }"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1520,
        360
      ],
      "id": "ef152a0c-3811-4a0e-afd1-de55b103892d",
      "name": "calcular_laje_dimensoes"
    },
    {
      "parameters": {
        "description": "Calcula materiais para laje quando voc√™ tem apenas a √°rea total. Use esta tool quando o cliente informar √°rea como '40m¬≤', '50 metros quadrados', '60m2', etc. Ideal para projetos onde voc√™ s√≥ conhece a √°rea total da laje.",
        "workflowId": {
          "__rl": true,
          "value": "={{$('Edit Fields').item.json.id.workflowferramentas}}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "operation": "calcLaje",
            "especificacoes": "={\n      \"largura\": \"{{ $fromAI('largura', 'Largura da laje em metros. Ex: para \\\"5x8\\\", extraia \\\"5\\\". Se n√£o informado ou formato √°rea (40m¬≤), deixe vazio.', 'string', '') }}\",\n      \"comprimento\": \"{{ $fromAI('comprimento', 'Comprimento da laje em metros. Ex: para \\\"5x8\\\", extraia \\\"8\\\". Se n√£o informado ou formato √°rea (40m¬≤), deixe vazio.', 'string', '') }}\",\n      \"enchimento\": \"{{ $fromAI('enchimento', 'Tipo de enchimento: \\\"isopor\\\" ou \\\"lajota\\\". Se cliente n√£o especificar, use \\\"isopor\\\".', 'string', 'isopor') }}\",\n      \"malha\": \"{{ $fromAI('malha', 'Tipo de malha: \\\"Leve\\\", \\\"Media\\\" ou \\\"Refor√ßada\\\". Se n√£o especificado, use \\\"Media\\\".', 'string', 'Media') }}\",\n      \"area\": \"{{ $fromAI('area', '√Årea total da laje em metros quadrados. Ex: para \\\"40m¬≤\\\", extraia \\\"40\\\". Use apenas se n√£o houver largura x comprimento.', 'string', '') }}\"\n    }"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tableName",
              "displayName": "tableName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "especificacoes",
              "displayName": "especificacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "ferragem",
              "displayName": "ferragem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "detalhes",
              "displayName": "detalhes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": true
            },
            {
              "id": "NomeProduto",
              "displayName": "NomeProduto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "leadid",
              "displayName": "leadid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Produtos",
              "displayName": "Produtos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Obs",
              "displayName": "Obs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1620,
        340
      ],
      "id": "100bf75d-ccb3-4d63-b86c-2aeb2e4fc2c6",
      "name": "calcular_laje_area"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        960,
        320
      ],
      "id": "faca2fb1-0d88-4ed0-81c1-6fa81499f617",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "3mNlZ20nDfXfgUl9",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "for (const item of items) {\n  const outputString = item.json.output;\n  let jsonString = outputString.replace(/```json\\n|```/g, '').trim();\n\n  // Tenta parsear a string JSON\n  try {\n    item.json = JSON.parse(jsonString);\n  } catch (e) {\n    // Em caso de erro, voc√™ pode logar, retornar um erro, ou lidar de outra forma\n    console.error(\"Erro ao parsear JSON:\", e, \"String original:\", jsonString);\n    // Opcional: Se quiser que o workflow falhe neste item\n    // throw new Error(\"Falha ao parsear JSON\");\n  }\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        20
      ],
      "id": "93a8971d-e8ff-4742-a534-da17e70240b5",
      "name": "Code2"
    },
    {
      "parameters": {
        "chatId": "7020998195",
        "text": "={{ $('When Executed by Another Workflow').item.json.whatsapp }}\n\n{{ $('Edit Fields').item.json.produtos.lista_produtos }}\n\n{{ $('Edit Fields').item.json.produtos.tipo_projeto }}\n\n{{ $('Edit Fields').item.json.produtos.dimensoes_laje }}\n\n\n\n{{ $('or√ßamentos').item.json.output }}",
        "replyMarkup": "inlineKeyboard",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2260,
        20
      ],
      "id": "72eda64e-1087-4070-8cc9-0dbb2a1535c5",
      "name": "Send a text message",
      "webhookId": "c06d1390-9891-4778-87c0-f9527c69a5a5",
      "credentials": {
        "telegramApi": {
          "id": "6Mh0z286j436leMd",
          "name": "Henrique_Orc"
        }
      }
    },
    {
      "parameters": {
        "operation": "incr",
        "key": "id_or√ßamento"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        200,
        40
      ],
      "id": "0cb35188-6114-4d82-9cce-09ba30070dee",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "sA2U6PkBocrwko3a",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "telegram",
        "messageData": "=\"message_id\": {{ $json.result.message_id }},\n\"orcamento_id\": {{ $('Redis').item.json[\"id_or√ßamento\"] }},\n\"whatsapp\": \"{{ $('When Executed by Another Workflow').item.json.whatsapp }}\",\n\"instace\": \"{{ $('When Executed by Another Workflow').item.json.instace }}\""
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2480,
        20
      ],
      "id": "e717fa12-ec06-44b5-a98a-0c39379e307c",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "sA2U6PkBocrwko3a",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "02eb1d7d-7dd1-4efc-9f1f-ef6956a864b2",
              "name": "Resposta",
              "value": "prosigar com o atendimento, estou consultando os pre√ßos",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2740,
        20
      ],
      "id": "fd27d0e9-f464-4991-b48c-8978fcb4d787",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "85c613cd-0b70-40f5-bcaa-6e0ca46b4697",
              "leftValue": "={{ $json.status }}",
              "rightValue": "completo",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1820,
        20
      ],
      "id": "2cc034c0-e4ed-41a4-8bfb-df4726edea9a",
      "name": "If"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "or√ßamentos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcular_ferragem_personalizada": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "salvar_orcamento": {
      "ai_tool": [
        []
      ]
    },
    "busca_preco": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "produtos_mais_cotados": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        []
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "calcular_laje_dimensoes": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "calcular_laje_area": {
      "ai_tool": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "or√ßamentos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "or√ßamentos": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "produtos": "  {\n\"lista_produtos\": \"3 treli√ßas cheia 6 metros, 100 lajotas de barro, 1 malha 3x2, 1kg arame queimado, 1 ferragem armada 7x15 ferro F10 (3x8), 2 vergalh√£o F8 (5/16) 12m\",\n  \"tipo_projeto\": \"produtos_isolados\",\n  \"dimensoes_laje\": \"\"\n}",
          "whatsapp": "558281036911",
          "instace": "meu cell"
        }
      }
    ]
  },
  "versionId": "a27cb396-4ee3-40b6-9aad-cf6e212fbb57",
  "triggerCount": 0,
  "tags": []
}